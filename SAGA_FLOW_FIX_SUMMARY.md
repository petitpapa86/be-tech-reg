# Saga Flow Fix Summary

## Problems Identified

Based on the logs and code analysis, there were **two critical issues** with the saga flow:

### 1. **Event Dispatching Issue**
**Problem**: `CreateStripeCustomerCommandHandler` was publishing events directly via `CrossModuleEventBus.publishEventSynchronously()` instead of routing them back through `SagaManager`.

**Why this is wrong**: 
- Events should be processed by `SagaManager.processEvent()` which:
  - Loads the saga from the repository
  - Routes the event to the appropriate saga handler
  - Persists the updated saga state
  - Dispatches any new commands generated by the saga

**Impact**: The saga never received the `StripeCustomerCreatedEvent` or `StripeCustomerCreationFailedEvent`, causing the saga to stall.

### 2. **Event Type Issue**
**Problem**: `StripeCustomerCreationFailedEvent` was defined as a plain `record` instead of extending `SagaMessage`.

**Why this is wrong**:
- All saga events must extend `SagaMessage` to be processable by the saga framework
- `SagaMessage` provides the `sagaId` association and event metadata needed for routing

**Impact**: Even if the event was dispatched correctly, the saga couldn't handle it because it wasn't a proper `SagaMessage`.

## Correct Saga Flow

```
UserRegisteredEventHandler
    ↓
    ├─ Creates BillingAccount, Subscription, Invoice
    └─ Starts PaymentVerificationSaga via SagaManager.startSaga()
          ↓
          SagaManager
              ├─ Creates saga instance
              ├─ Dispatches SagaStartedEvent to saga
              ├─ Saga handles event → generates CreateStripeCustomerCommand
              ├─ Persists saga snapshot
              └─ Dispatches CreateStripeCustomerCommand via CommandDispatcher
                    ↓
                    CreateStripeCustomerCommandHandler (listens for command)
                        ├─ Calls PaymentService.createCustomer()
                        ├─ On Success: Creates StripeCustomerCreatedEvent
                        ├─ On Failure: Creates StripeCustomerCreationFailedEvent
                        └─ Routes event back to SagaManager.processEvent() ✅ (FIXED)
                              ↓
                              SagaManager.processEvent()
                                  ├─ Loads saga from repository
                                  ├─ Routes event to saga handler
                                  ├─ Saga processes event → may generate next command
                                  ├─ Persists updated saga state
                                  └─ Dispatches new commands (if any)
```

## Changes Made

### 1. Fixed `StripeCustomerCreationFailedEvent`
**File**: `regtech-billing/domain/src/main/java/com/bcbs239/regtech/billing/domain/payments/events/StripeCustomerCreationFailedEvent.java`

**Before**:
```java
public record StripeCustomerCreationFailedEvent(
    SagaId sagaId,
    String errorMessage
) {}
```

**After**:
```java
@Getter
public class StripeCustomerCreationFailedEvent extends SagaMessage {
    private final String errorMessage;

    public StripeCustomerCreationFailedEvent(SagaId sagaId, String errorMessage) {
        super("StripeCustomerCreationFailedEvent", Instant.now(), sagaId, sagaId.toString(), sagaId.toString());
        this.errorMessage = errorMessage;
    }
}
```

### 2. Updated `PaymentVerificationSaga` to Handle Failure Event
**File**: `regtech-billing/application/src/main/java/com/bcbs239/regtech/billing/application/payments/PaymentVerificationSaga.java`

**Added**:
- Import for `StripeCustomerCreationFailedEvent`
- Handler registration: `onEvent(StripeCustomerCreationFailedEvent.class, this::handleStripeCustomerCreationFailed)`
- Handler method:
```java
private void handleStripeCustomerCreationFailed(StripeCustomerCreationFailedEvent event) {
    data.setFailureReason("Stripe customer creation failed: " + event.getErrorMessage());
    // Cancel the payment timeout since we're failing
    timeoutScheduler.cancel(getId().id() + "-payment-timeout");
    updateStatus();
}
```

### 3. Fixed Event Routing in `CreateStripeCustomerCommandHandler`
**File**: `regtech-billing/application/src/main/java/com/bcbs239/regtech/billing/application/subscriptions/CreateStripeCustomerCommandHandler.java`

**Before**:
```java
private final CrossModuleEventBus crossModuleEventBus;

// ...

// Publish success event
StripeCustomerCreatedEvent event = new StripeCustomerCreatedEvent(sagaId, customer.customerId().getValue());
crossModuleEventBus.publishEventSynchronously(event);

// ...

private void publishFailureEvent(SagaId sagaId, String errorMessage) {
    StripeCustomerCreationFailedEvent failureEvent = new StripeCustomerCreationFailedEvent(sagaId, errorMessage);
    crossModuleEventBus.publishEventSynchronously(failureEvent);
}
```

**After**:
```java
private final SagaManager sagaManager;

// ...

// Publish success event to saga via SagaManager
StripeCustomerCreatedEvent event = new StripeCustomerCreatedEvent(sagaId, customer.customerId().getValue());
sagaManager.processEvent(event);

// ...

private void publishFailureEvent(SagaId sagaId, String errorMessage) {
    StripeCustomerCreationFailedEvent failureEvent = new StripeCustomerCreationFailedEvent(sagaId, errorMessage);
    sagaManager.processEvent(failureEvent);
}
```

## Key Architectural Principles

### Command Flow
1. **Sagas dispatch commands** via `dispatchCommand()` (stored in saga's command list)
2. **SagaManager publishes commands** via `CommandDispatcher` after persisting saga
3. **CommandDispatcher uses Spring's ApplicationEventPublisher** to broadcast commands
4. **Command handlers listen** using `@EventListener` annotation

### Event Flow (Back to Saga)
1. **Command handlers create saga events** (`SagaMessage` subclasses)
2. **Events are routed through `SagaManager.processEvent()`** - NOT CrossModuleEventBus!
3. **SagaManager loads the saga** and calls `saga.handle(event)`
4. **Saga processes event** and may generate new commands
5. **SagaManager persists saga** and dispatches new commands

### When to Use CrossModuleEventBus
- **Integration Events**: For events crossing bounded contexts (e.g., `UserRegisteredIntegrationEvent`)
- **Domain Events**: For local domain events within a module (e.g., `BillingUserRegisteredEvent`)
- **NOT for Saga Events**: Saga events must go through `SagaManager.processEvent()`

## Testing the Fix

After these changes, the saga flow should work correctly:

1. ✅ `UserRegisteredEventHandler` starts the saga
2. ✅ Saga handles `SagaStartedEvent` and dispatches `CreateStripeCustomerCommand`
3. ✅ `CreateStripeCustomerCommandHandler` handles the command
4. ✅ Handler routes `StripeCustomerCreatedEvent` or `StripeCustomerCreationFailedEvent` to `SagaManager`
5. ✅ `SagaManager` loads saga and processes event
6. ✅ Saga handles event and transitions to next state or fails gracefully

## Expected Log Output (After Fix)

```
CREATE_STRIPE_CUSTOMER_COMMAND_RECEIVED - details={sagaId=..., userName=..., userEmail=...}
STRIPE_CUSTOMER_CREATED_PUBLISHED - details={sagaId=..., stripeCustomerId=...}
SAGA_EVENT_PROCESSED - details={sagaType=PaymentVerificationSaga, sagaId=..., eventType=StripeCustomerCreated}
SAGA_COMMAND_DISPATCHED - details={sagaType=PaymentVerificationSaga, commandType=CreateStripeSubscriptionCommand}
```

Or on failure:
```
CREATE_STRIPE_CUSTOMER_COMMAND_RECEIVED - details={sagaId=..., userName=..., userEmail=...}
STRIPE_CUSTOMER_CREATION_FAILED - details={sagaId=..., error=...}
SAGA_EVENT_PROCESSED - details={sagaType=PaymentVerificationSaga, sagaId=..., eventType=StripeCustomerCreationFailed}
SAGA_FAILED - details={sagaId=..., failureReason=...}
```
