# ============================================================================
# RegTech Application - Root Configuration
# ============================================================================
# This file contains SHARED infrastructure configuration that applies across
# all modules. Module-specific configuration should be placed in:
#   - regtech-{module}/infrastructure/src/main/resources/application-{module}.yml
#
# Shared Configuration Includes:
#   - Spring application settings
#   - Database configuration (datasource, JPA, Flyway)
#   - Logging configuration
#   - Metrics and monitoring (Spring Actuator)
#   - Security configuration (JWT, OAuth2, public paths)
#   - Event processing (inbox/outbox)
#
# Module-Specific Configuration (in separate files):
#   - Module business logic settings
#   - Module-specific storage configuration
#   - Module-specific processing parameters
#   - Module-specific integrations
#   - Module-specific performance tuning
#
# Requirements: 1.1, 1.4, 8.1
# ============================================================================

# ============================================================================
# SPRING APPLICATION SETTINGS & DATABASE CONFIGURATION
# ============================================================================
# Shared configuration for all modules
# Requirements: 3.1, 3.4, 3.5
spring:
  application:
    name: regtech
  
  main:
    allow-bean-definition-overriding: true
  
  profiles:
    active: development
    include:
      - iam
      - billing
      - ingestion
      - data-quality
      - risk-calculation
      - report-generation
  
  mvc:
    favicon:
      enabled: false
  
  # Database configuration
  datasource:
    url: jdbc:postgresql://localhost:5432/regtech
    driver-class-name: org.postgresql.Driver
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:dracons86}
  
  jpa:
    hibernate:
      ddl-auto: update
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        default_schema: public
        jdbc:
          lob:
            non_contextual_creation: true
        format_sql: false
    show-sql: false
    open-in-view: false
    database-platform: org.hibernate.dialect.PostgreSQLDialect
  
  sql:
    init:
      mode: always
      schema-locations: classpath:schema.sql
  
  # Flyway migration configuration (Requirement 3.2)
  # Loads migrations from all module directories
  flyway:
    enabled: false
    locations:
      - classpath:db/migration/common
      - classpath:db/migration/ingestion
      - classpath:db/migration/data-quality
      - classpath:db/migration/risk-calculation
      - classpath:db/migration/report-generation
      - classpath:db/migration/billing
      - classpath:db/migration/iam
  
  docker:
    compose:
      enabled: false

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
# Shared logging configuration for all modules
# Requirements: 4.1, 4.2, 4.3, 4.4, 4.5
logging:
  # Logback configuration file for structured logging
  config: classpath:logback-spring.xml
  
  # Log levels per module
  level:
    # Core framework
    com.bcbs239.regtech: INFO
    
    # Event processing components
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO
    
    # Bounded contexts (modules)
    com.bcbs239.regtech.iam: INFO
    com.bcbs239.regtech.billing: INFO
    com.bcbs239.regtech.modules.ingestion: INFO
    com.bcbs239.regtech.dataquality: INFO
    com.bcbs239.regtech.riskcalculation: INFO
    com.bcbs239.regtech.reportgeneration: INFO
    
    # Spring framework
    org.springframework.security: WARN
    org.springframework: WARN
    org.springframework.scheduling: INFO
    
    # Database
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
  
  # Console logging pattern
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ============================================================================
# METRICS AND MONITORING CONFIGURATION
# ============================================================================
# Spring Actuator configuration for health checks and metrics
# Requirements: 5.1, 5.2, 5.3
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  
  endpoint:
    health:
      show-details: when-authorized
  
  health:
    diskspace:
      enabled: true

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
# Centralized security configuration for all modules
# Requirements: 11.1, 11.2, 11.5
iam:
  security:
    # JWT configuration
    jwt:
      # HS512 requires a key of at least 512 bits (64 bytes)
      # This default is 128 characters (base64-safe) for development only
      # In production, use a secure random key via JWT_SECRET environment variable
      secret: ${JWT_SECRET:mySecretKey123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890}
      expiration: 86400  # 24 hours in seconds (deprecated, use access-token-expiration-minutes)
      access-token-expiration-minutes: 15  # 15 minutes (Requirement 5.1)
      refresh-token-expiration-days: 7  # 7 days (Requirement 5.2)
    
    # Password policy
    password:
      min-length: 12
      require-uppercase: true
      require-lowercase: true
      require-digits: true
      require-special-chars: true
    
    # OAuth2 providers
    oauth2:
      google:
        client-id: ${GOOGLE_CLIENT_ID:}
        client-secret: ${GOOGLE_CLIENT_SECRET:}
      facebook:
        client-id: ${FACEBOOK_CLIENT_ID:}
        client-secret: ${FACEBOOK_CLIENT_SECRET:}
    
    # Public paths (no authentication required)
    # Requirements: 11.2, 11.5
    # These paths are accessible without a JWT token
    public-paths:
      # Public API endpoints
      - /api/public/**
      
      # Authentication endpoints (must be public for login/registration)
      - /api/auth/login
      - /api/auth/register
      - /api/auth/forgot-password
      - /api/v1/users/register
      - /api/v1/auth/login
      - /api/v1/auth/refresh
      - /api/v1/auth/select-bank
      
      # Health check endpoints (public for monitoring)
      - /api/health
      - /actuator/health
      - /api/v1/ingestion/health
      - /api/v1/data-quality/health
      - /api/v1/data-quality/health/**
      - /api/v1/risk-calculation/health
      - /api/v1/risk-calculation/health/**
      - /api/v1/report-generation/health
      - /api/v1/report-generation/health/**
      
      # API documentation endpoints (public for developers)
      - /swagger-ui/**
      - /v3/api-docs/**
  
  # Authorization settings
  authorization:
    cache:
      enabled: true
      ttl: 300  # 5 minutes
    multi-tenant:
      enabled: true
      default-organization: "default-org"
    permissions:
      strict-mode: true
      audit-enabled: true

# ============================================================================
# EVENT PROCESSING CONFIGURATION
# ============================================================================
# Shared event processing configuration (inbox/outbox pattern)
regtech:
  # Outbox pattern configuration
  outbox:
    enabled: true
    processing-interval: 30000  # 30 seconds
    retry-interval: 60000  # 1 minute
    max-retries: 3
    cleanup-interval: 86400000  # 24 hours
    cleanup-retention-days: 30
  
  # Inbox pattern configuration
  inbox:
    enabled: true
    processing-interval: 10000  # 10 seconds
    batch-size: 20
    parallel-processing-enabled: false
  
  # Event retry configuration
  event:
    retry:
      interval: 60000  # Check every 60 seconds
      batch-size: 10   # Process 10 events per batch
      max-retries: 5   # Maximum retry attempts
      enabled: true    # Enable/disable retry processing
  
  # Bank registry service configuration
  bank-registry:
    base-url: ${BANK_REGISTRY_URL:http://localhost:8081}
    timeout: 30000  # 30 seconds
    retry-attempts: 3

# Inbox processing configuration (bound to InboxOptions)
inbox:
  poll-interval: 5s  # Poll interval as a Spring Duration
  batch-size: 10
  parallel-processing-enabled: false

# Outbox processing configuration (bound to OutboxOptions)
outbox:
  poll-interval: 30s  # Poll interval as a Spring Duration
  batch-size: 10
  parallel-processing-enabled: false

# ============================================================================
# PROFILE-SPECIFIC OVERRIDES
# ============================================================================

---
# ============================================================================
# DEVELOPMENT PROFILE
# ============================================================================
# Requirements: 7.1, 7.2
spring:
  config:
    activate:
      on-profile: development
  
  # Development database settings
  datasource:
    url: jdbc:postgresql://localhost:5432/regtech
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:dracons86}

# Development logging settings
logging:
  level:
    com.bcbs239.regtech: DEBUG
    com.bcbs239.regtech.core.events: DEBUG
    com.bcbs239.regtech.core.inbox: DEBUG
    com.bcbs239.regtech.core.outbox: DEBUG
    com.bcbs239.regtech.modules.ingestion: DEBUG
    com.bcbs239.regtech.dataquality: DEBUG
    com.bcbs239.regtech.riskcalculation: DEBUG
    com.bcbs239.regtech.reportgeneration: DEBUG

# ============================================================================
# RULES ENGINE CONFIGURATION EXAMPLES
# ============================================================================
# Example configurations for different scenarios
# Uncomment and modify as needed

# Example 1: Disable Rules Engine (not recommended)
# data-quality:
#   rules-engine:
#     enabled: false  # This will cause validation to fail

# Example 2: Disable caching (for debugging)
# data-quality:
#   rules-engine:
#     cache-enabled: false  # Rules loaded from DB every time

# Example 3: Aggressive caching (for high-volume production)
# data-quality:
#   rules-engine:
#     cache-enabled: true
#     cache-ttl: 600  # 10 minutes

# Example 4: Minimal logging (for production)
# data-quality:
#   rules-engine:
#     logging:
#       log-executions: false
#       log-violations: true
#       log-summary: true

# Example 5: Verbose logging (for debugging)
# data-quality:
#   rules-engine:
#     logging:
#       log-executions: true
#       log-violations: true
#       log-summary: true

# Example 6: Strict performance thresholds
# data-quality:
#   rules-engine:
#     performance:
#       warn-threshold-ms: 50  # Warn if rule takes > 50ms
#       max-execution-time-ms: 2000  # Warn if validation takes > 2s

# Example 7: Relaxed performance thresholds
# data-quality:
#   rules-engine:
#     performance:
#       warn-threshold-ms: 200  # Warn if rule takes > 200ms
#       max-execution-time-ms: 10000  # Warn if validation takes > 10s

---
# ============================================================================
# PRODUCTION PROFILE
# ============================================================================
# Requirements: 7.1, 7.3
spring:
  config:
    activate:
      on-profile: production
  
  # Production database settings (use environment variables)
  datasource:
    url: ${DB_URL:jdbc:postgresql://localhost:5432/regtech}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# Production logging settings
logging:
  level:
    com.bcbs239.regtech: INFO
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO

---
# ============================================================================
# GCP PROFILE (Google Cloud Platform)
# ============================================================================
# Enable JSON structured logging for Google Cloud Logging
spring:
  config:
    activate:
      on-profile: gcp

logging:
  # GCP profile enables JSON structured logging
  level:
    com.bcbs239.regtech: INFO
    # Increase verbosity for event processing in GCP
    com.bcbs239.regtech.core.events: DEBUG
    com.bcbs239.regtech.core.inbox: DEBUG
    com.bcbs239.regtech.core.outbox: DEBUG
    # Module debugging in GCP
    com.bcbs239.regtech.modules.ingestion: DEBUG
  
  # Enable structured logging when running in the gcp profile
  structured:
    enabled: true
