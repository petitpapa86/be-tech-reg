# ============================================================================
# RegTech Application - Root Configuration
# ============================================================================
# This file contains SHARED infrastructure configuration that applies across
# all modules. Module-specific configuration should be placed in:
#   - regtech-{module}/infrastructure/src/main/resources/application-{module}.yml
#
# Shared Configuration Includes:
#   - Spring application settings
#   - Database configuration (datasource, JPA, Flyway)
#   - Logging configuration
#   - Metrics and monitoring (Spring Actuator)
#   - Security configuration (JWT, OAuth2, public paths)
#   - Event processing (inbox/outbox)
#
# Module-Specific Configuration (in separate files):
#   - Module business logic settings
#   - Module-specific storage configuration
#   - Module-specific processing parameters
#   - Module-specific integrations
#   - Module-specific performance tuning
#
# Requirements: 1.1, 1.4, 8.1
# ============================================================================

# ============================================================================
# SPRING APPLICATION SETTINGS & DATABASE CONFIGURATION
# ============================================================================
# Shared configuration for all modules
# Requirements: 3.1, 3.4, 3.5
spring:
  application:
    name: regtech

  jackson:
    mapper:
      accept-case-insensitive-properties: true
  
  main:
    allow-bean-definition-overriding: true
  
  profiles:
    active: development
    include:
      - iam
      - billing
      - ingestion
      - risk-calculation
      - report-generation
      - observability
  
  mvc:
    favicon:
      enabled: false
  
  # Multipart file upload configuration
  servlet:
    multipart:
      enabled: true
      max-file-size: 500MB
      max-request-size: 500MB
      file-size-threshold: 10MB
  
  # Database configuration
  datasource:
    url: jdbc:postgresql://localhost:5432/regtech
    driver-class-name: org.postgresql.Driver
    username: postgres #${DB_USERNAME:myuser}
    password: dracons86 #${DB_PASSWORD:secret}

    # Connection pool (HikariCP)
    # Spring Boot uses HikariCP by default when it's on the classpath; these settings make it explicit and tunable.
    hikari:
      pool-name: regtech-hikari
      maximum-pool-size: ${DB_POOL_MAX_SIZE:20}
      minimum-idle: ${DB_POOL_MIN_IDLE:5}
      connection-timeout: ${DB_POOL_CONNECTION_TIMEOUT_MS:30000}
      validation-timeout: ${DB_POOL_VALIDATION_TIMEOUT_MS:5000}
      idle-timeout: ${DB_POOL_IDLE_TIMEOUT_MS:600000}
      max-lifetime: ${DB_POOL_MAX_LIFETIME_MS:1800000}
      register-mbeans: true

      # Optional diagnostics / "GC"-style housekeeping:
      # - leak-detection-threshold: logs a warning if a connection is not returned in time (0 disables).
      # - keepalive-time: helps keep NAT/proxies from killing idle connections (0 disables).
      leak-detection-threshold: ${DB_POOL_LEAK_DETECTION_MS:0}
      keepalive-time: ${DB_POOL_KEEPALIVE_MS:0}
      data-source-properties:
        # Improves JDBC batching behavior for PostgreSQL.
        reWriteBatchedInserts: true
        ApplicationName: regtech
  
  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        # Hibernate 7.x dialect for PostgreSQL
        dialect: org.hibernate.dialect.PostgreSQLDialect
        default_schema: public
        
        # Schema management - let Flyway handle DDL (Requirement 3.2)
        hbm2ddl:
          auto: none  # Don't auto-create schema, Flyway manages migrations
        
        # JDBC settings
        jdbc:
          lob:
            non_contextual_creation: true
          # Batch processing for better performance (Hibernate 7.x optimized)
          batch_size: 20
          batch_versioned_data: true
        
        # Query optimization (Hibernate 7.x features)
        order_inserts: true
        order_updates: true
        
        # SQL formatting (disabled for production performance)
        format_sql: false
        use_sql_comments: false
        
        # Connection handling
        connection:
          provider_disables_autocommit: false
        
        # JPA 3.2 / Hibernate 7.x compatibility
        # Uses org.springframework.orm.jpa.hibernate package for Hibernate-specific features
        # Supports StatelessSession for transactional operations
        # Supports PersistenceConfiguration API
    
    show-sql: false
    open-in-view: false
    database-platform: org.hibernate.dialect.PostgreSQLDialect
  
  sql:
    init:
      mode: never  # Disable schema.sql execution - Flyway manages all migrations
  
  # Flyway migration configuration (Requirement 3.2)
  # Loads migrations from all module directories
  flyway:
    enabled: true  # Re-enable Flyway to run the UUID conversion migrations
    baseline-on-migrate: true  # For existing databases with tables already created
    baseline-version: 0
    out-of-order: true  # Allow out-of-order migrations
    locations:
      - classpath:db/migration
      - classpath:db/migration/common
      - classpath:db/migration/iam
      - classpath:db/migration/billing
      - classpath:db/migration/ingestion
      - classpath:db/migration/reportgeneration
    schemas:
      - public
      - regtech
      - core
      - iam
      - billing
      - ingestion
      - dataquality
      - riskcalculation
      - reportgeneration
  
  docker:
    compose:
      enabled: false

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
# Shared logging configuration for all modules
# Requirements: 4.1, 4.2, 4.3, 4.4, 4.5
logging:
  # Logback configuration file for structured logging
  config: classpath:logback-spring.xml
  
  # Log levels per module
  level:
    # Core framework
    com.bcbs239.regtech: INFO
    
    # Event processing components
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO
    
    # Bounded contexts (modules)
    com.bcbs239.regtech.iam: INFO
    com.bcbs239.regtech.billing: INFO
    com.bcbs239.regtech.modules.ingestion: INFO
    com.bcbs239.regtech.dataquality: INFO
    com.bcbs239.regtech.riskcalculation: INFO
    com.bcbs239.regtech.reportgeneration: INFO
    
    # Spring framework
    org.springframework.security: WARN
    org.springframework: WARN
    org.springframework.scheduling: INFO
    org.springframework.boot.actuate: WARN
    org.springframework.boot.actuate.endpoint: WARN
    
    # Database
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
  
  # Console logging pattern
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ============================================================================
# SPRING BOOT 4 OBSERVABILITY CONFIGURATION (Hetzner Deployment)
# ============================================================================
# Spring Boot 4 OpenTelemetry auto-configuration with Hetzner-specific settings
# Requirements: 1.1, 2.1, 3.1
management:
  # OpenTelemetry resource attributes (Hetzner-specific)
  opentelemetry:
    resource-attributes:
      service.name: bcbs239-platform
      service.version: ${app.version:0.0.1-SNAPSHOT}
      deployment.environment: ${spring.profiles.active:development}
      deployment.provider: hetzner
      deployment.region: ${HETZNER_DATACENTER:fsn1}  # Falkenstein datacenter
      deployment.zone: ${HETZNER_ZONE:fsn1-dc14}
  
  # Distributed tracing configuration
  tracing:
    enabled: true
    sampling:
      probability: ${TRACE_SAMPLING_RATE:0.1}  # 10% sampling for production, 100% for dev
    export:
      otlp:
        endpoint: ${OTEL_COLLECTOR_ENDPOINT:http://localhost:4318/v1/traces}
        timeout: 10s
        compression: gzip
  
  # Metrics export configuration
  metrics:
    export:
      otlp:
        enabled: true
        endpoint: ${OTEL_COLLECTOR_ENDPOINT:http://localhost:4318/v1/metrics}
        timeout: 10s
    enable:
      jvm: true
      process: true
      system: true
      http: true
      logback: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active}
      deployment.provider: hetzner
  
  # Observation annotations support
  observations:
    annotations:
      enabled: true

  # Actuator endpoints for Hetzner deployment
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,info
      base-path: /actuator
  
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
      roles: ACTUATOR
    metrics:
      enabled: true
      roles: ACTUATOR
    prometheus:
      enabled: true
  
  health:
    diskspace:
      enabled: true
    ssl:
      enabled: true

  # Security for production Hetzner deployment
  security:
    enabled: true

# ============================================================================
# OBSERVABILITY NOTIFICATIONS CONFIGURATION
# ============================================================================
# Alert notification configuration for multiple channels
# Requirements: 5.1, 5.2, 5.3, 5.4, 5.5
observability:
  notifications:
    # Email notifications
    email:
      enabled: ${OBSERVABILITY_EMAIL_ENABLED:false}
      from: ${OBSERVABILITY_EMAIL_FROM:alerts@bcbs239.com}
      to: ${OBSERVABILITY_EMAIL_TO:}
    
    # Slack notifications
    slack:
      enabled: ${OBSERVABILITY_SLACK_ENABLED:false}
      webhook-url: ${OBSERVABILITY_SLACK_WEBHOOK_URL:}
    
    # Generic webhook notifications
    webhook:
      enabled: ${OBSERVABILITY_WEBHOOK_ENABLED:false}
      url: ${OBSERVABILITY_WEBHOOK_URL:}

# SendGrid configuration
sendgrid:
  api:
    key: ${SENDGRID_API_KEY:}

# ============================================================================
# CORS CONFIGURATION
# ============================================================================
# Cross-Origin Resource Sharing configuration for all modules
# Spring Framework 7 Behavior: Pre-flight requests are not rejected when CORS config is empty
# We provide explicit configuration to maintain security policies
# Requirements: 12.1, 12.2, 12.3, 12.4, 12.5
cors:
  # Allowed origins for cross-origin requests (Requirement 12.3)
  allowed-origins: ${CORS_ALLOWED_ORIGINS:http://localhost:3000,http://localhost:4200}
  
  # Allowed HTTP methods (Requirement 12.2)
  allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS,PATCH}
  
  # Allowed request headers (Requirement 12.4)
  allowed-headers: ${CORS_ALLOWED_HEADERS:*}
  
  # Exposed response headers (Requirement 12.4)
  exposed-headers: ${CORS_EXPOSED_HEADERS:X-Correlation-ID,Authorization}
  
  # Allow credentials (cookies, authorization headers)
  allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
  
  # Max age for pre-flight requests in seconds (Requirement 12.2)
  max-age: ${CORS_MAX_AGE:3600}

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
# Centralized security configuration for all modules
# Requirements: 11.1, 11.2, 11.5
iam:
  security:
    # JWT configuration
    jwt:
      # HS512 requires a key of at least 512 bits (64 bytes)
      # This default is 128 characters (base64-safe) for development only
      # In production, use a secure random key via JWT_SECRET environment variable
      secret: ${JWT_SECRET:mySecretKey123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890}
      expiration: 86400  # 24 hours in seconds (deprecated, use access-token-expiration-minutes)
      access-token-expiration-minutes: 180  # 3 hours (Requirement 5.1)
      refresh-token-expiration-days: 7  # 7 days (Requirement 5.2)
    
    # Password policy
    password:
      min-length: 12
      require-uppercase: true
      require-lowercase: true
      require-digits: true
      require-special-chars: true
    
    # OAuth2 providers
    oauth2:
      google:
        client-id: ${GOOGLE_CLIENT_ID:}
        client-secret: ${GOOGLE_CLIENT_SECRET:}
      facebook:
        client-id: ${FACEBOOK_CLIENT_ID:}
        client-secret: ${FACEBOOK_CLIENT_SECRET:}
    
    # Public paths (no authentication required)
    # Requirements: 11.2, 11.5
    # These paths are accessible without a JWT token
    public-paths:
      # Public API endpoints
      - /api/public/**
      
      # Authentication endpoints (must be public for login/registration)
      - /api/auth/login
      - /api/auth/register
      - /api/auth/forgot-password
      - /api/v1/users/register
      - /api/v1/auth/login
      - /api/v1/auth/refresh
      - /api/v1/auth/select-bank
      
      # Health check endpoints (public for monitoring)
      - /api/health
      - /actuator/health
      - /actuator/prometheus
      - /actuator/metrics
      - /api/v1/ingestion/health
      - /api/v1/data-quality/health
      - /api/v1/data-quality/health/**
      - /api/v1/risk-calculation/health
      - /api/v1/risk-calculation/health/**
      - /api/v1/report-generation/health
      - /api/v1/report-generation/health/**
      
      # API documentation endpoints (public for developers)
      - /swagger-ui/**
      - /v3/api-docs/**
  
  # Authorization settings
  authorization:
    cache:
      enabled: true
      ttl: 300  # 5 minutes
    multi-tenant:
      enabled: true
      default-organization: "default-org"
    permissions:
      strict-mode: true
      audit-enabled: true

# ============================================================================
# EVENT PROCESSING CONFIGURATION
# ============================================================================
# Shared event processing configuration (inbox/outbox pattern)
regtech:
  # Outbox pattern configuration
  outbox:
    enabled: true
    processing-interval: 30000  # 30 seconds
    retry-interval: 60000  # 1 minute
    max-retries: 3
    cleanup-interval: 86400000  # 24 hours
    cleanup-retention-days: 30
  
  # Inbox pattern configuration
  inbox:
    enabled: true
    processing-interval: 10000  # 10 seconds
    batch-size: 20
    parallel-processing-enabled: false
  
  # Event retry configuration
  event:
    retry:
      interval: 60000  # Check every 60 seconds
      batch-size: 10   # Process 10 events per batch
      max-retries: 5   # Maximum retry attempts
      enabled: true    # Enable/disable retry processing
  
  # Bank registry service configuration
  bank-registry:
    base-url: ${BANK_REGISTRY_URL:http://localhost:8081}
    timeout: 30000  # 30 seconds
    retry-attempts: 3

  # Risk calculation configuration
  risk-calculation:
    processing:
      # Cap in-flight exposure processing tasks. Keep this below DB_POOL_MAX_SIZE to avoid
      # exhausting JDBC connections when other modules also use the pool.
      max-in-flight: ${RISK_CALCULATION_MAX_IN_FLIGHT:8}

# Inbox processing configuration (bound to InboxOptions)
inbox:
  poll-interval: 5s  # Poll interval as a Spring Duration
  batch-size: 10
  parallel-processing-enabled: false

# Outbox processing configuration (bound to OutboxOptions)
outbox:
  poll-interval: 30s  # Poll interval as a Spring Duration
  batch-size: 10
  parallel-processing-enabled: false

# ============================================================================
# PROFILE-SPECIFIC OVERRIDES
# ============================================================================

---
# ============================================================================
# DEVELOPMENT PROFILE
# ============================================================================
# Requirements: 7.1, 7.2
spring:
  config:
    activate:
      on-profile: development
  
  # Development database settings
  datasource:
    url: jdbc:postgresql://localhost:5433/regtech
    username: ${DB_USERNAME:myuser}
    password: ${DB_PASSWORD:secret}

# Development logging settings
logging:
  level:
    com.bcbs239.regtech: INFO
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO
    com.bcbs239.regtech.modules.ingestion: INFO
    com.bcbs239.regtech.dataquality: INFO
    com.bcbs239.regtech.riskcalculation: INFO
    com.bcbs239.regtech.reportgeneration: INFO

# ============================================================================
# DATA QUALITY & RULES ENGINE CONFIGURATION
# ============================================================================
# Configuration for the Data Quality Rules Engine
# Requirements: 3.3, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5
data-quality:
  rules-engine:
    # Enable the Rules Engine (REQUIRED)
    enabled: true
    
    # Cache configuration (Requirement 5.1, 5.2, 5.3, 5.4, 5.5)
    cache-enabled: true
    cache-ttl: 300  # 5 minutes - rules cached in memory
    
    # Logging configuration (Requirement 6.1, 6.2, 6.3, 6.4, 6.5)
    logging:
      log-executions: true    # Log individual rule executions (Requirement 6.1)
      log-violations: true    # Log violation details (Requirement 6.2)
      log-summary: true       # Log summary statistics (Requirement 6.4)
    
    # Performance monitoring (Requirement 6.5)
    performance:
      warn-threshold-ms: 100        # Warn if single rule takes > 100ms
      max-execution-time-ms: 5000   # Warn if total validation takes > 5s

# ============================================================================
# RULES ENGINE CONFIGURATION EXAMPLES
# ============================================================================
# Example configurations for different scenarios
# Uncomment and modify as needed

# Example 1: Disable Rules Engine (not recommended)
# data-quality:
#   rules-engine:
#     enabled: false  # This will cause validation to fail

# Example 2: Disable caching (for debugging)
# data-quality:
#   rules-engine:
#     cache-enabled: false  # Rules loaded from DB every time

# Example 3: Aggressive caching (for high-volume production)
# data-quality:
#   rules-engine:
#     cache-enabled: true
#     cache-ttl: 600  # 10 minutes

# Example 4: Minimal logging (for production)
# data-quality:
#   rules-engine:
#     logging:
#       log-executions: false
#       log-violations: true
#       log-summary: true

# Example 5: Verbose logging (for debugging)
# data-quality:
#   rules-engine:
#     logging:
#       log-executions: true
#       log-violations: true
#       log-summary: true

# Example 6: Strict performance thresholds
# data-quality:
#   rules-engine:
#     performance:
#       warn-threshold-ms: 50  # Warn if rule takes > 50ms
#       max-execution-time-ms: 2000  # Warn if validation takes > 2s

# Example 7: Relaxed performance thresholds
# data-quality:
#   rules-engine:
#     performance:
#       warn-threshold-ms: 200  # Warn if rule takes > 200ms
#       max-execution-time-ms: 10000  # Warn if validation takes > 10s

---
# ============================================================================
# PRODUCTION PROFILE
# ============================================================================
# Requirements: 7.1, 7.3
spring:
  config:
    activate:
      on-profile: production
  
  # Production database settings (use environment variables)
  datasource:
    url: ${DB_URL:jdbc:postgresql://localhost:5433/regtech}
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}

# Production logging settings
logging:
  level:
    com.bcbs239.regtech: INFO
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO

---
# ============================================================================
# GCP PROFILE (Google Cloud Platform)
# ============================================================================
# Enable JSON structured logging for Google Cloud Logging
spring:
  config:
    activate:
      on-profile: gcp

logging:
  # GCP profile enables JSON structured logging
  level:
    com.bcbs239.regtech: INFO
    # Increase verbosity for event processing in GCP
    com.bcbs239.regtech.core.events: INFO
    com.bcbs239.regtech.core.inbox: INFO
    com.bcbs239.regtech.core.outbox: INFO
    # Module debugging in GCP
    com.bcbs239.regtech.modules.ingestion: INFO
  
  # Enable structured logging when running in the gcp profile
  structured:
    enabled: true
