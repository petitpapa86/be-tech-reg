<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCBS 239 - Rapporto Comprensivo di Rischio e Qualit√†</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        @page {
            size: A4;
            margin: 0; /* Remove browser default headers/footers */
        }
        @media print {
            body { 
                margin: 0;
                padding: 10mm; /* Reduced padding */
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                font-size: 8pt; /* Further reduced font size */
                zoom: 0.75; /* Further scale down */
            }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            
            /* Prevent cutting sections inside */
            .rounded-lg, .shadow-lg, .card, 
            div[class*="rounded"], div[class*="shadow"], div[class*="border"] {
                break-inside: avoid !important;
                page-break-inside: avoid !important;
                display: block; /* Ensure block formatting context */
            }
            
            /* Allow tables to break across pages but keep rows intact */
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            tfoot {
                display: table-footer-group;
            }
            
            /* Ensure headings stay with their content */
            h1, h2, h3, h4, h5, h6 {
                break-after: avoid;
                page-break-after: avoid;
            }

            /* Adjust spacing for print */
            .p-8 { padding: 0.75rem !important; }
            .mb-12 { margin-bottom: 1rem !important; }
            .gap-6 { gap: 0.5rem !important; }
            
            /* Override container width for print */
            .max-w-7xl {
                max-width: none !important;
                width: 100% !important;
            }
            
            /* Fixed Footer for Print */
            .print-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                z-index: 1000;
                font-size: 7pt; /* Smaller footer font */
                background-color: white; /* Ensure readability */
                padding-top: 5px;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- HIDDEN COPILOT INSTRUCTIONS -->
    <div id="copilot-instructions" style="display:none;">
        ### ROLE AND CONTEXT 
        You are processing a BCBS 239 Compliance Report for an Italian banking institution. 
        This is a dual-section regulatory document combining Large Exposures (Grandi Rischi) 
        under Banca d'Italia Circular 285/2013 and Data Quality Assessment under BCBS 239 principles. 
        
        ### DOCUMENT STRUCTURE RULES (MUST RESPECT) 
        1. **Hierarchical Sections** : The document has exactly 2 main sections: 
           -  SECTION 1: Large Exposures (risk data, exposure limits, sector distribution) 
           -  SECTION 2: Data Quality (6 dimensions: Completeness, Accuracy, Consistency, Timeliness, Uniqueness, Validity) 
        
        2. **Visual Encoding System** : 
           -  Colors indicate severity: Red (Critical >25% limit / Score <65%), Orange (Warning), Green (Compliant >90%) 
           -  Charts: Doughnut (sector distribution), Horizontal Bar (top exposures), Progress bars (quality scores) 
           -  Badges: "LIMITE SUPERATO" (red), "CONFORME" (green), "NON CONFORME" (red) 
        
        3. **Data Fields to Extract** : 
           -  Bank metadata: ABI code, Reference date, Batch ID 
           -  Financial: Capital amounts, Exposure values, Percentages of capital 
           -  Quality metrics: 6 dimension scores (0-100%), Error counts, Validation rates 
        
        4. **Critical Thresholds**  (Regulatory Limits): 
           -  Large Exposure threshold: ‚â•10% of eligible capital 
           -  Legal limit: 25% of eligible capital (breach = "LIMITE SUPERATO") 
           -  Quality passing score: ‚â•75% (acceptable), ‚â•90% (excellent) 
        
        5. **Language and Localization** : 
           -  Primary language: Italian 
           -  Currency format: ‚Ç¨ X.XXX.XXX,XX (Italian notation) 
           -  Date format: DD/MM/YYYY 
           -  Legal references must remain exact: "Circolare n. 285 del 17 dicembre 2013"
    </div>

    <div class="max-w-7xl mx-auto p-8 pb-24 print:pb-0">

        <!-- ============================================ -->
        <!-- COVER PAGE -->
        <!-- ============================================ -->
        <section class="bg-gradient-to-br from-blue-600 via-purple-600 to-blue-700 rounded-lg shadow-2xl p-12 mb-8 text-white">
            <div class="text-center">
                <div class="mb-8">
                    <div class="inline-block bg-white/10 backdrop-blur-sm rounded-full px-6 py-2 mb-4">
                        <span class="text-sm font-semibold tracking-wider">BCBS 239 COMPLIANCE PLATFORM</span>
                    </div>
                </div>

                <h1 class="text-5xl font-bold mb-4">BCBS 239 RISK AGGREGATION REPORT</h1>
                <h2 class="text-3xl font-light mb-8">Reference Date: <span th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2025-12-15</span></h2>

                <div class="border-t border-white/30 my-8"></div>

                <div class="grid grid-cols-3 gap-6 mb-8">
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                        <p class="text-sm opacity-75 mb-1">Bank</p>
                        <p class="text-xl font-bold" th:text="${metadata.bankName}">Banca</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                        <p class="text-sm opacity-75 mb-1">Reference Date</p>
                        <p class="text-xl font-bold" th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2025-12-15</p>
                    </div>
                    <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4">
                        <p class="text-sm opacity-75 mb-1">Report ID</p>
                        <p class="text-lg font-mono" th:text="${metadata.batchId.value()}">batch_20251215</p>
                    </div>
                </div>

                <div class="text-sm opacity-75">
                    <p class="font-bold tracking-widest">CONFIDENTIAL / INTERNAL USE ONLY</p>
                    <p class="mt-1">Generated by BCBS 239 Process Engine</p>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- SECTION 1: LARGE EXPOSURES (GRANDI RISCHI) -->
        <!-- ============================================ -->

        <section class="mb-12">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="border-b-4 border-blue-600 pb-4 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold mb-3">
                                SEZIONE 1
                            </div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                RAPPORTO GRANDI RISCHI
                            </h1>
                            <p class="text-lg text-gray-600">
                                Circolare n. 285 del 17 dicembre 2013 - Banca d'Italia
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <p class="text-sm font-semibold">Data Riferimento</p>
                                <p class="text-xl font-bold" th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2024-09-30</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">BANCA</h3>
                        <p class="text-xl font-bold text-gray-900" th:text="${metadata.bankName}">Banca</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-semibold">Codice ABI:</span> <span th:text="${metadata.bankId.value()}">08081</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Report ID:</span> <span class="font-mono text-xs" th:text="${metadata.batchId.value()}">report_id</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Generato:</span> <span th:text="${#temporals.format(metadata.generatedAt, 'dd/MM/yyyy HH:mm:ss')}">01/01/2024 10:00:00</span></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">PATRIMONIO DI VIGILANZA</h3>
                        <div class="space-y-2">
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Fondi Propri Totali</p>
                                <p class="text-lg font-bold text-gray-900" 
                                   th:text="${capitalBreakdown.totalOwnFunds != null ? 
                                             '‚Ç¨ ' + #numbers.formatDecimal(capitalBreakdown.totalOwnFunds, 1, 2) : 
                                             calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Capitale Tier 1</p>
                                <p class="text-lg font-bold text-gray-900" th:text="${calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                <p class="text-xs text-blue-800 font-semibold">Capitale Eleggibile Grandi Rischi</p>
                                <p class="text-lg font-bold text-blue-900" th:text="${calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="largeExposures=${calculationResults.largeExposures},
                          largeCount=${calculationResults.largeExposuresCount},
                          totalPctCapital=${(calculationResults.tierOneCapital.value().doubleValue() > 0) ? (calculationResults.totalAmount.value().doubleValue() * 100.0 / calculationResults.tierOneCapital.value().doubleValue()) : 0.0}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Riepilogo Esecutivo
                </h2>

                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Grandi Esposizioni</p>
                        <p class="text-4xl font-bold mt-2" th:text="${largeCount}">0</p>
                        <p class="text-xs mt-2 opacity-75">‚â• 10% capitale eleggibile</p>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Importo Totale</p>
                        <p class="text-2xl font-bold mt-2" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(calculationResults.totalAmount.value().doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(totalPctCapital, 1, 1)}">0.0</span>% capitale</p>
                    </div>

                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Superamento Limite</p>
                        <p class="text-4xl font-bold mt-2" th:text="${calculationResults.limitBreaches}">0</p>
                        <p class="text-xs mt-2 opacity-75">&gt; 25% capitale eleggibile</p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Settori Coinvolti</p>
                        <p class="text-4xl font-bold mt-2" th:text="${riskConcentration.sectorsInvolved}">0</p>
                        <p class="text-xs mt-2 opacity-75">Diversificazione settoriale</p>
                    </div>
                </div>
            </div>

            <!-- Sector Distribution -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Distribuzione Settoriale
                </h2>

                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Ripartizione per Settore</h3>
                            <canvas id="sectorPieChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Esposizione per Settore (EUR)</h3>
                            <canvas id="sectorBarChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sector Details Table (dynamic) -->
                <div class="mt-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Settore</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">N. Esposizioni</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Importo Totale</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">% su Totale</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">% Capitale</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="row : ${riskSectorRows}" class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:classappend="${row.theme == 'bank' ? ' bg-green-100 text-green-800' : row.theme == 'insurance' ? ' bg-purple-100 text-purple-800' : row.theme == 'other' ? ' bg-gray-100 text-gray-800' : ' bg-blue-100 text-blue-800'}"
                                          th:text="${row.label}">SETTORE</span>
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-medium" th:text="${row.count}">0</td>
                                <td class="px-4 py-3 text-right text-sm font-bold" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(row.amountEur, 1, 2)}">‚Ç¨ 0.00</td>
                                <td class="px-4 py-3 text-right text-sm font-semibold text-blue-600">
                                    <span th:text="${#numbers.formatDecimal(row.percentOfTotal, 1, 2)}">0.00</span>%
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-semibold">
                                    <span th:text="${#numbers.formatDecimal(row.percentOfCapital, 1, 2)}">0.00</span>%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top 10 Exposures -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Top 10 Esposizioni
                </h2>

                <div class="mb-6">
                    <canvas id="top10Chart" style="max-height: 400px;"></canvas>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div th:each="card : ${riskTopExposureCards}"
                         class="p-4 rounded-lg"
                         th:classappend="${card.theme == 'rank1' ? ' bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500' : card.theme == 'rank2' ? ' bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-500' : card.theme == 'rank3' ? ' bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-500' : card.theme == 'bank' ? ' bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500' : card.theme == 'insurance' ? ' bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-500' : card.theme == 'other' ? ' bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400' : ' bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs font-semibold uppercase"
                                   th:text="${(card.medal != null and !#strings.isEmpty(card.medal) ? card.medal + ' ' : '') + card.rank + '¬∞ - ' + card.counterpartyName}">ü•á 1¬∞ - CONTROPARTE</p>
                                <p class="text-2xl font-bold mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(card.amountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                                <p class="text-sm mt-1" th:text="${#numbers.formatDecimal(card.percentOfCapital, 1, 2) + '% del capitale ‚Ä¢ ' + card.sectorLabel}">0.00% del capitale</p>
                            </div>
                            <div class="text-right" th:if="${card.rank <= 3}">
                                <span class="inline-flex items-center px-3 py-1 text-xs font-bold rounded-full border"
                                      th:classappend="${card.limitExceeded ? ' bg-red-100 text-red-800 border-red-600' : ' bg-green-100 text-green-800 border-green-600'}"
                                      th:text="${card.limitExceeded ? '‚ö†Ô∏è LIMITE SUPERATO' : '‚úì CONFORME'}">‚úì CONFORME</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Concentration Metrics -->
                <div class="mt-6 grid grid-cols-3 gap-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-red-800 uppercase">Concentrazione Top 3</p>
                        <p class="text-2xl font-bold text-red-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.top3AmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-red-700"><span th:text="${#numbers.formatDecimal(riskConcentration.top3PercentOfTotal, 1, 2)}">0.00</span>% del totale esposizioni</p>
                    </div>

                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-orange-800 uppercase">Concentrazione Top 5</p>
                        <p class="text-2xl font-bold text-orange-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.top5AmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-orange-700"><span th:text="${#numbers.formatDecimal(riskConcentration.top5PercentOfTotal, 1, 2)}">0.00</span>% del totale esposizioni</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-blue-800 uppercase">Esposizione Media</p>
                        <p class="text-2xl font-bold text-blue-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.avgExposureAmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-blue-700"><span th:text="${#numbers.formatDecimal(riskConcentration.avgExposurePercentOfCapital, 1, 2)}">0.00</span>% del capitale eleggibile</p>
                    </div>
                </div>
            </div>

            <!-- Compliance Notes -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="eligible=${calculationResults.tierOneCapital.toFormattedString()}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Note di Conformit√†
                </h2>

                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <h4 class="font-bold text-blue-900 mb-2">üìã Soglia Grande Esposizione</h4>
                        <p class="text-sm text-blue-800">
                            Un'esposizione √® considerata "grande rischio" quando rappresenta il <strong>10% o pi√π</strong>
                            del capitale eleggibile della banca (<span th:text="${eligible}">‚Ç¨ 0.00</span>).
                        </p>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
                        <h4 class="font-bold text-amber-900 mb-2">‚ö†Ô∏è Limite Legale Generale</h4>
                        <p class="text-sm text-amber-800">
                            Il limite generale per le grandi esposizioni √® del <strong>25%</strong> del capitale eleggibile.
                            Esposizioni superiori richiedono esenzioni specifiche o autorizzazioni supervisorie.
                        </p>
                    </div>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4">
                        <h4 class="font-bold text-green-900 mb-2">‚úì Esenzioni Applicabili</h4>
                        <p class="text-sm text-green-800 mb-2">
                            Le seguenti esenzioni possono essere applicate secondo la normativa:
                        </p>
                        <ul class="list-disc list-inside text-sm text-green-800 space-y-1">
                            <li>Titoli di Stato italiani (esenti da limite)</li>
                            <li>Covered bond con garanzia statale (limite 500%)</li>
                            <li>Esposizioni verso enti creditizi della stessa rete</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- SECTION 2: DATA QUALITY -->
        <!-- ============================================ -->

        <section class="page-break">

            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="border-b-4 border-purple-600 pb-4 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-bold mb-3">
                                SEZIONE 2
                            </div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                RAPPORTO DATA QUALITY
                            </h1>
                            <p class="text-lg text-gray-600">
                                BCBS 239 - Principi per l'aggregazione dei dati di rischio e l'informativa di rischio
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-purple-600 text-white px-4 py-2 rounded-lg">
                                <p class="text-sm font-semibold">Data Riferimento</p>
                                <p class="text-xl font-bold" th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2025-11-17</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">BANCA</h3>
                        <p class="text-xl font-bold text-gray-900" th:text="${metadata.bankName}">Banca Cooperativa Trentina SpA</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-semibold">Bank ID:</span> <span th:text="${metadata.bankId.value()}">daa4a072</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Report ID:</span>
                                <span th:text="${'qr_' + metadata.batchId.value()}" class="font-mono">qr_4c28380f-5fc2-4034-bffd-4f21038c0391</span>
                            </p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Batch ID:</span> <span th:text="${qualityResults.batchId.value()}" class="font-mono">batch_20251117_221306_e86335e4</span></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">STATO VALIDAZIONE</h3>
                        <div class="space-y-2">
                            <div class="bg-red-50 p-3 rounded border border-red-200">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-red-800 font-semibold">Stato Conformit√†</p>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full"
                                          th:classappend="${qualityResults.complianceStatus.name() == 'COMPLIANT' ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}"
                                          th:text="${qualityResults.complianceStatus.name() == 'COMPLIANT' ? 'CONFORME' : 'NON CONFORME'}">
                                        NON CONFORME
                                    </span>
                                </div>
                            </div>
                            <div class="p-3 rounded border"
                                 th:classappend="${qualityResults.attentionLevel.name() == 'LOW' ? ' bg-green-50 border-green-200' : qualityResults.attentionLevel.name() == 'MEDIUM' ? ' bg-yellow-50 border-yellow-200' : ' bg-red-50 border-red-200'}">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs font-semibold"
                                       th:classappend="${qualityResults.attentionLevel.name() == 'LOW' ? ' text-green-800' : qualityResults.attentionLevel.name() == 'MEDIUM' ? ' text-yellow-800' : ' text-red-800'}">Livello di Attenzione</p>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full"
                                          th:classappend="${qualityResults.attentionLevel.name() == 'LOW' ? ' bg-green-600 text-white' : qualityResults.attentionLevel.name() == 'MEDIUM' ? ' bg-yellow-600 text-white' : ' bg-red-600 text-white'}"
                                          th:text="${qualityResults.attentionLevel.name() == 'CRITICAL' ? 'IMMEDIATO' : qualityResults.attentionLevel.name() == 'HIGH' ? 'ALTO' : qualityResults.attentionLevel.name() == 'MEDIUM' ? 'MEDIO' : 'BASSO'}">
                                        IMMEDIATO
                                    </span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Tempo di Elaborazione</p>
                                <p class="text-lg font-bold text-gray-900">1 ms</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall Score -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Punteggio Complessivo
                </h2>

                <div class="grid grid-cols-5 gap-4 mb-6"
                     th:with="validRate=${(qualityResults.totalExposures != null and qualityResults.totalExposures > 0) ? ((qualityResults.validExposures * 100.0) / qualityResults.totalExposures) : 0.0},
                              errorRate=${(qualityResults.totalExposures != null and qualityResults.totalExposures > 0) ? ((qualityResults.totalErrors * 100.0) / qualityResults.totalExposures) : 0.0}">
                    <div class="col-span-2 bg-gradient-to-br rounded-lg p-8 text-white"
                         th:with="g=${qualityResults.overallGrade.name()}"
                         th:classappend="${g == 'A' ? ' from-green-500 to-green-600' : g == 'B' ? ' from-amber-500 to-amber-600' : g == 'C' ? ' from-yellow-500 to-yellow-600' : g == 'D' ? ' from-orange-500 to-orange-600' : ' from-red-500 to-red-600'}">
                        <p class="text-sm font-semibold opacity-90 mb-2">QUALITY SCORE</p>
                        <div class="flex items-end space-x-4">
                            <p class="text-6xl font-bold"><span th:text="${#numbers.formatDecimal(qualityResults.overallScore, 1, 1)}">46.0</span>%</p>
                            <p class="text-4xl font-bold pb-2 opacity-90" th:text="${qualityResults.overallGrade.name()}">F</p>
                        </div>
                        <p class="text-xs mt-3 opacity-75 uppercase tracking-wide"
                           th:with="g=${qualityResults.overallGrade.name()}"
                           th:text="${g == 'A' ? 'EXCELLENT - Industry Leading' : g == 'B' ? 'GOOD - Minor Improvements Needed' : g == 'C' ? 'ACCEPTABLE - Some Improvements Needed' : g == 'D' ? 'WEAK - Requires Action' : 'POOR - Requires Immediate Action'}">GOOD - Minor Improvements Needed</p>
                    </div>

                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Esposizioni Totali</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.totalExposures}">5</p>
                        <p class="text-xs mt-2 opacity-75">Analizzate</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Esposizioni Valide</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.validExposures}">0</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(validRate, 1, 1)}">0.0</span>% validation rate</p>
                    </div>

                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Errori Totali</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.totalErrors}">16</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(errorRate, 1, 1)}">100.0</span>% error rate</p>
                    </div>
                </div>
            </div>

            <!-- Dimension Scores -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="cpl=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS)},
                          acc=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY)},
                          con=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY)},
                          tim=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS)},
                          uni=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS)},
                          val=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY)},
                          cplErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS).count : 0},
                          accErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY).count : 0},
                          conErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY).count : 0},
                          timErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS).count : 0},
                          uniErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS).count : 0},
                          valErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY).count : 0}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Punteggi per Dimensione di Qualit√†
                </h2>

                <div class="space-y-4">
                    <th:block th:replace="~{fragments/color-rules-generated :: dimensionScores}"></th:block>
                </div>
            </div>

            <!-- Error Distribution -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="cplCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS).count : 0},
                          accCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY).count : 0},
                          conCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY).count : 0},
                          maxCnt=${(cplCnt >= accCnt and cplCnt >= conCnt) ? cplCnt : (accCnt >= conCnt ? accCnt : conCnt)}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Distribuzione Errori per Dimensione
                </h2>

                <div class="grid grid-cols-3 gap-6">
                    <th:block th:replace="~{fragments/color-rules-generated :: errorDistributionCards}"></th:block>
                </div>
            </div>

            <!-- Quality Insights -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Analisi e Raccomandazioni
                </h2>

                <div id="qualityInsightsContainer" class="space-y-4"></div>
            </div>

            <!-- BCBS 239 Compliance -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Conformit√† BCBS 239
                </h2>

                <div class="space-y-4">
                    <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
                        <h4 class="font-bold text-purple-900 mb-2">üìò Principi BCBS 239</h4>
                        <p class="text-sm text-purple-800 mb-3">
                            Il Basel Committee on Banking Supervision ha stabilito 14 principi fondamentali per l'aggregazione
                            dei dati di rischio e l'informativa di rischio. I principi relativi alla qualit√† dei dati includono:
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 3: Accuratezza e Integrit√†</p>
                                <p class="text-xs text-purple-800">I dati devono essere accurati e affidabili</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 4: Completezza</p>
                                <p class="text-xs text-purple-800">I dati devono essere completi e disponibili</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 5: Tempestivit√†</p>
                                <p class="text-xs text-purple-800">I dati devono essere aggiornati e disponibili on-demand</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 6: Adattabilit√†</p>
                                <p class="text-xs text-purple-800">I sistemi devono essere flessibili per nuove esigenze</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-900 mb-3">Valutazione Conformit√† per Principio</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center" 
                                 th:each="assessment : ${bcbs239Compliance}">
                                <span class="text-sm text-gray-700" th:text="${assessment.principle}">
                                    Principle 3 - Accuracy
                                </span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${assessment.compliant ? 
                                                      ' bg-green-100 text-green-800' : 
                                                      ' bg-red-100 text-red-800'}"
                                      th:text="${assessment.compliant ? 'CONFORME' : 'NON CONFORME'}">
                                    CONFORME
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <!-- ============================================ -->
        <!-- FOOTER -->
        <!-- ============================================ -->

        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg p-8 text-center text-white shadow-lg">
            <p class="text-lg font-bold mb-2">Rapporto generato da BCBS 239 Process Engine</p>
            <p class="mb-4">
                Template v2024.1 ‚Ä¢ Generato il <span th:text="${#temporals.format(metadata.generatedAt, 'dd/MM/yyyy')}">15/12/2025</span> alle ore <span th:text="${#temporals.format(metadata.generatedAt, 'HH:mm:ss')}">12:15:46</span>
            </p>
            <div class="border-t border-white/30 my-4"></div>
            <p class="text-sm opacity-90">Conforme a Circolare n. 285 di Banca d'Italia e Principi BCBS 239</p>
            <p class="text-xs mt-2 opacity-75">
                Per informazioni: <a href="https://www.bancaditalia.it" class="underline hover:no-underline">www.bancaditalia.it</a> ‚Ä¢
                <a href="https://www.bis.org/publ/bcbs239.htm" class="underline hover:no-underline">www.bis.org/publ/bcbs239.htm</a>
            </p>
        </div>

        <!-- Print Button -->
        <div class="mt-8 text-center no-print">
            <button onclick="window.print()"
                    class="bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-4 px-12 rounded-lg shadow-lg transition duration-200 transform hover:scale-105">
                üñ®Ô∏è Stampa Rapporto Completo / Salva PDF
            </button>
        </div>
        
    </div>
    
    <!-- Chart.js Scripts -->
    <script th:inline="javascript">
        /*
        ============================================
        Quality Insights - YAML aligned configuration
        Source: color-rules-config-COMPLETE.yaml
        ============================================
        dimension_scores.thresholds.excellent.value = 90.0
        dimension_scores.thresholds.acceptable.value = 75.0
        error_distribution.thresholds.critical.value = 100
        error_distribution.thresholds.high.value = 50
        error_distribution.thresholds.medium.value = 10
        quality_insights.severity_thresholds.critical.overall_score_below = 65.0
        quality_insights.analysis_config.top_dimensions_to_analyze = 3
        */

        const qualityRules = {
            // From: global.color_palette.*
            insightColors: {
                critical: { bg: 'bg-red-50', border: 'border-red-200', title: 'text-red-800', text: 'text-red-800' },
                high: { bg: 'bg-orange-50', border: 'border-orange-200', title: 'text-orange-800', text: 'text-orange-800' },
                medium: { bg: 'bg-yellow-50', border: 'border-yellow-200', title: 'text-yellow-800', text: 'text-yellow-800' },
                success: { bg: 'bg-green-50', border: 'border-green-200', title: 'text-green-800', text: 'text-green-800' },
                info: { bg: 'bg-blue-50', border: 'border-blue-200', title: 'text-blue-800', text: 'text-blue-800' }
            },

            // From: dimension_scores.thresholds
            dimensionScoreThresholds: {
                excellent: 90.0,
                acceptable: 75.0
            },

            // From: dimension_scores.thresholds.excellent.value (applied to all dimensions)
            dimensionThresholds: {
                COMPLETENESS: 90,
                ACCURACY: 90,
                CONSISTENCY: 90,
                TIMELINESS: 90,
                UNIQUENESS: 90,
                VALIDITY: 90
            },

            // From: error_distribution.thresholds
            errorThresholds: {
                critical: 100,
                high: 50,
                medium: 10
            },

            // From: quality_insights.severity_thresholds
            severityThresholds: {
                critical: { overallScore: 65.0, validationRate: 20.0, errorRate: 50.0, anyDimensionScore: 50.0 },
                high: { overallScore: 75.0, validationRate: 50.0, errorRate: 20.0, anyDimensionScore: 65.0 },
                medium: { overallScore: 85.0, validationRate: 80.0, errorRate: 10.0, anyDimensionScore: 75.0 }
            },

            // From: quality_insights.analysis_config
            analysisConfig: {
                topDimensions: 3,
                minExcellentScore: 95.0
            }
        };

        const safeNumber = (value, fallback = 0) => {
            const n = Number(value);
            return Number.isFinite(n) ? n : fallback;
        };

        const safePct = (num, den) => {
            const d = safeNumber(den, 0);
            if (d <= 0) return 0;
            return (safeNumber(num, 0) / d) * 100;
        };

        const formatPct = (value, digits = 1) => safeNumber(value, 0).toFixed(digits);

        const titleCase = (s) => {
            const str = (s ?? '').toString().toLowerCase();
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        };

        const dimensionDisplayName = (dimensionName) => {
            const n = (dimensionName ?? '').toString().toUpperCase();
            switch (n) {
                case 'COMPLETENESS': return 'Completeness';
                case 'ACCURACY': return 'Accuracy';
                case 'CONSISTENCY': return 'Consistency';
                case 'TIMELINESS': return 'Timeliness';
                case 'UNIQUENESS': return 'Uniqueness';
                case 'VALIDITY': return 'Validity';
                default: return titleCase(n);
            }
        };

        const getQualityGrade = (score) => {
            const s = safeNumber(score, 0);
            if (s >= 95) return { grade: 'A', label: 'EXCELLENT', severity: 'success', color: 'green' };
            if (s >= 85) return { grade: 'B', label: 'GOOD', severity: 'info', color: 'blue' };
            if (s >= 75) return { grade: 'C', label: 'ACCEPTABLE', severity: 'warning', color: 'yellow' };
            if (s >= 65) return { grade: 'D', label: 'POOR', severity: 'error', color: 'orange' };
            if (s >= 50) return { grade: 'E', label: 'CRITICAL', severity: 'critical', color: 'red' };
            return { grade: 'F', label: 'UNACCEPTABLE', severity: 'critical', color: 'red' };
        };

        const getAttentionLevel = (score, errorCount, validExposures, totalExposures) => {
            const validationRate = safePct(validExposures, totalExposures);
            const errorRate = safePct(errorCount, totalExposures);
            const s = safeNumber(score, 0);

            // From: quality_insights.severity_thresholds
            if (
                s < qualityRules.severityThresholds.critical.overallScore ||
                validationRate < qualityRules.severityThresholds.critical.validationRate ||
                errorRate > qualityRules.severityThresholds.critical.errorRate
            ) {
                return { level: 'CRITICO', color: 'red', icon: 'üö®', priority: 1 };
            }
            if (
                s < qualityRules.severityThresholds.high.overallScore ||
                validationRate < qualityRules.severityThresholds.high.validationRate ||
                errorRate > qualityRules.severityThresholds.high.errorRate
            ) {
                return { level: 'ALTO', color: 'orange', icon: '‚ö†Ô∏è', priority: 2 };
            }
            if (
                s < qualityRules.severityThresholds.medium.overallScore ||
                validationRate < qualityRules.severityThresholds.medium.validationRate ||
                errorRate > qualityRules.severityThresholds.medium.errorRate
            ) {
                return { level: 'MEDIO', color: 'yellow', icon: '‚ö°', priority: 3 };
            }
            return { level: 'BASSO', color: 'green', icon: '‚úì', priority: 4 };
        };

        const getComplianceStatus = (score) => {
            const s = safeNumber(score, 0);
            // From: dimension_scores.thresholds
            if (s >= qualityRules.dimensionScoreThresholds.excellent) {
                return { status: 'CONFORME', color: 'green', badge: { bg: 'bg-green-100', text: 'text-green-800' } };
            }
            if (s >= qualityRules.dimensionScoreThresholds.acceptable) {
                return { status: 'PARZIALMENTE CONFORME', color: 'yellow', badge: { bg: 'bg-yellow-100', text: 'text-yellow-800' } };
            }
            return { status: 'NON CONFORME', color: 'red', badge: { bg: 'bg-red-100', text: 'text-red-800' } };
        };

        const rankDimensionsByPriority = (dimensions) => {
            return [...(dimensions ?? [])].sort((a, b) => {
                const be = safeNumber(b.errorCount, 0);
                const ae = safeNumber(a.errorCount, 0);
                if (be !== ae) return be - ae;
                return safeNumber(a.score, 0) - safeNumber(b.score, 0);
            });
        };

        const isCriticalSituation = (qualityReport) => {
            const overallScore = safeNumber(qualityReport?.overallScore, 0);
            const totalExposures = safeNumber(qualityReport?.totalExposures, 0);
            const validExposures = safeNumber(qualityReport?.validExposures, 0);
            const errorCount = safeNumber(qualityReport?.errorCount, 0);
            const validationRate = safePct(validExposures, totalExposures);
            const errorRate = safePct(errorCount, totalExposures);
            const anyDimensionBelowCritical = (qualityReport?.dimensions ?? []).some(
                d => safeNumber(d.score, 0) < qualityRules.severityThresholds.critical.anyDimensionScore
            );

            return (
                overallScore < qualityRules.severityThresholds.critical.overallScore ||
                validationRate < qualityRules.severityThresholds.critical.validationRate ||
                errorRate > qualityRules.severityThresholds.critical.errorRate ||
                anyDimensionBelowCritical ||
                validExposures === 0
            );
        };

        const generateCriticalInsight = (qualityReport) => {
            const overallScore = safeNumber(qualityReport.overallScore, 0);
            const totalExposures = safeNumber(qualityReport.totalExposures, 0);
            const validExposures = safeNumber(qualityReport.validExposures, 0);
            const errorCount = safeNumber(qualityReport.errorCount, 0);
            const worstDimension = rankDimensionsByPriority(qualityReport.dimensions).find(d => safeNumber(d.score, 0) > 0 || safeNumber(d.errorCount, 0) > 0)
                || rankDimensionsByPriority(qualityReport.dimensions)[0]
                || { name: 'Completeness' };

            return {
                severity: 'critical',
                icon: 'üö®',
                title: 'Situazione Critica - Azione Immediata Richiesta',
                content: `Il punteggio complessivo di qualit√† del ${formatPct(overallScore, 0)}% indica una situazione critica che richiede intervento immediato. ${validExposures} su ${totalExposures} esposizioni analizzate presentano errori di validazione.`,
                priority: `Affrontare immediatamente i problemi di ${dimensionDisplayName(worstDimension.name)}.`
            };
        };

        const generateDimensionInsight = (dimension, qualityReport) => {
            const nameKey = (dimension?.name ?? '').toString().toUpperCase();
            const score = safeNumber(dimension?.score, 0);
            const errors = safeNumber(dimension?.errorCount, 0);
            const displayName = dimensionDisplayName(nameKey);

            if (nameKey === 'COMPLETENESS') {
                return {
                    severity: 'high',
                    icon: 'üìä',
                    title: 'Problemi di Completezza dei Dati',
                    content: `La dimensione Completeness mostra il punteggio pi√π basso (${formatPct(score, 0)}%) con ${errors} errori identificati. Questo indica che campi obbligatori mancano o non sono popolati correttamente.`,
                    recommendation: 'Verificare i processi di data entry e assicurarsi che tutti i campi obbligatori siano correttamente valorizzati nei sistemi di origine.'
                };
            }

            if (nameKey === 'ACCURACY') {
                return {
                    severity: 'medium',
                    icon: 'üéØ',
                    title: 'Problemi di Accuratezza',
                    content: `La dimensione Accuracy presenta un punteggio del ${formatPct(score, 0)}% con ${errors} errori. I dati potrebbero non riflettere correttamente le informazioni effettive delle esposizioni.`,
                    recommendation: "Implementare controlli di riconciliazione tra i sistemi sorgente e il data warehouse per garantire l'accuratezza delle informazioni."
                };
            }

            const threshold = qualityRules.dimensionThresholds[nameKey] ?? qualityRules.dimensionScoreThresholds.excellent;
            const isBelowThreshold = score < threshold;
            if (!isBelowThreshold) {
                return null;
            }

            const severity = score < 60 ? 'critical' : score < 75 ? 'high' : 'medium';
            const icon = severity === 'critical' ? 'üö®' : severity === 'high' ? '‚ö†Ô∏è' : '‚ö°';

            let recommendation = 'Rafforzare i controlli di qualit√† e standardizzare i processi di validazione.';
            if (nameKey === 'CONSISTENCY') recommendation = 'Standardizzare i formati e le regole di validazione tra sistemi sorgente e data warehouse.';
            if (nameKey === 'TIMELINESS') recommendation = 'Ottimizzare i processi di aggiornamento dati per ridurre ritardi e garantire disponibilit√† tempestiva.';
            if (nameKey === 'UNIQUENESS') recommendation = 'Implementare controlli anti-duplicazione e procedure di master data management.';
            if (nameKey === 'VALIDITY') recommendation = 'Rafforzare le regole di validazione (formati, range, vincoli) nei sistemi di origine.';

            return {
                severity,
                icon,
                title: `Criticit√† su ${displayName}`,
                content: `La dimensione ${displayName} presenta un punteggio del ${formatPct(score, 0)}% con ${errors} errori.`,
                recommendation
            };
        };

        const generatePositiveInsight = (goodDimensions) => {
            const names = (goodDimensions ?? []).map(d => dimensionDisplayName(d.name)).filter(Boolean);
            return {
                severity: 'success',
                icon: '‚úÖ',
                title: 'Aspetti Positivi',
                content: `Le dimensioni ${names.join(', ')} mostrano punteggi eccellenti (>95%), indicando che:`,
                bulletPoints: [
                    'I dati sono aggiornati e disponibili nei tempi richiesti',
                    'Non ci sono duplicazioni nei record',
                    'I formati dei dati rispettano le regole di validazione'
                ]
            };
        };

        const generateShortTermActions = (dimensions, severity) => {
            const actions = [];
            const worst = rankDimensionsByPriority(dimensions).slice(0, 2).map(d => dimensionDisplayName(d.name)).filter(Boolean);
            const worstLabel = worst.length ? worst.join(' e ') : 'Completezza e Accuratezza';

            if (severity === 'critical' || severity === 'error') {
                actions.push('Analisi dettagliata degli errori di ' + worstLabel);
                actions.push('Identificazione dei campi mancanti o errati');
                actions.push('Correzione manuale delle esposizioni critiche');
            } else if (severity === 'warning') {
                actions.push('Revisione dei processi di raccolta dati');
                actions.push('Analisi delle cause radice degli errori');
                actions.push('Implementazione di quick wins');
            } else {
                actions.push('Monitoraggio continuo delle metriche di qualit√†');
                actions.push('Ottimizzazione dei processi esistenti');
            }
            return actions;
        };

        const generateMediumTermActions = (dimensions, severity) => {
            const actions = [];
            if (severity === 'critical' || severity === 'error') {
                actions.push('Implementazione di controlli automatici nei sistemi sorgente');
                actions.push('Sviluppo di processi di riconciliazione automatica');
                actions.push('Formazione degli operatori sui requisiti di qualit√†');
            } else if (severity === 'warning') {
                actions.push('Potenziamento dei controlli di qualit√† esistenti');
                actions.push('Automazione dei processi manuali');
                actions.push('Integrazione di nuovi data quality check');
            } else {
                actions.push('Implementazione di advanced analytics');
                actions.push('Ottimizzazione delle performance');
            }
            return actions;
        };

        const generateLongTermActions = (dimensions, severity) => {
            const actions = [
                'Implementazione di data governance framework',
                'Automazione completa dei controlli di qualit√†',
                'Monitoraggio continuo e reporting automatico'
            ];
            if (severity === 'critical' || severity === 'error') {
                actions.unshift("Revisione completa dell'architettura dei dati");
                actions.push('Implementazione di machine learning per anomaly detection');
            }
            return actions;
        };

        const generateActionPlanInsight = (qualityReport) => {
            const overallScore = safeNumber(qualityReport?.overallScore, 0);
            const grade = getQualityGrade(overallScore);
            const severity = grade.severity;
            return {
                severity: 'info',
                icon: 'üìã',
                title: "Piano d'Azione Consigliato",
                shortTerm: generateShortTermActions(qualityReport.dimensions, severity),
                mediumTerm: generateMediumTermActions(qualityReport.dimensions, severity),
                longTerm: generateLongTermActions(qualityReport.dimensions, severity)
            };
        };

        const generateQualityInsights = (qualityReport) => {
            const insights = [];
            const overallScore = safeNumber(qualityReport?.overallScore, 0);

            if (isCriticalSituation(qualityReport)) {
                insights.push(generateCriticalInsight(qualityReport));
            }

            const worstDimensions = rankDimensionsByPriority(qualityReport?.dimensions)
                .slice(0, qualityRules.analysisConfig.topDimensions);
            worstDimensions.forEach(dim => {
                if (safeNumber(dim.score, 0) < qualityRules.dimensionScoreThresholds.excellent) {
                    const insight = generateDimensionInsight(dim, qualityReport);
                    if (insight) insights.push(insight);
                }
            });

            const goodDimensions = (qualityReport?.dimensions ?? []).filter(
                d => safeNumber(d.score, 0) >= qualityRules.analysisConfig.minExcellentScore
            );
            if (goodDimensions.length > 0) {
                insights.push(generatePositiveInsight(goodDimensions));
            }

            insights.push(generateActionPlanInsight(qualityReport));
            return insights;
        };

        const renderInsight = (insight) => {
            const palette = qualityRules.insightColors[insight.severity] || qualityRules.insightColors.info;
            const wrap = document.createElement('div');
            wrap.className = `${palette.bg} border-l-4 ${palette.border} p-4`;

            const bullets = Array.isArray(insight.bulletPoints) && insight.bulletPoints.length
                ? `<ul class="list-disc list-inside text-sm ${palette.text} space-y-1 ml-4">${insight.bulletPoints.map(li => `<li>${li}</li>`).join('')}</ul>`
                : '';

            const plan = (insight.shortTerm || insight.mediumTerm || insight.longTerm)
                ? `
                    <p class="text-sm ${palette.text} mb-2"><strong>Breve Termine (1-2 settimane):</strong></p>
                    <ul class="list-disc list-inside text-sm ${palette.text} space-y-1 ml-4 mb-3">${(insight.shortTerm ?? []).map(a => `<li>${a}</li>`).join('')}</ul>
                    <p class="text-sm ${palette.text} mb-2"><strong>Medio Termine (1-3 mesi):</strong></p>
                    <ul class="list-disc list-inside text-sm ${palette.text} space-y-1 ml-4 mb-3">${(insight.mediumTerm ?? []).map(a => `<li>${a}</li>`).join('')}</ul>
                    <p class="text-sm ${palette.text} mb-2"><strong>Lungo Termine (3-6 mesi):</strong></p>
                    <ul class="list-disc list-inside text-sm ${palette.text} space-y-1 ml-4">${(insight.longTerm ?? []).map(a => `<li>${a}</li>`).join('')}</ul>
                `
                : '';

            wrap.innerHTML = `
                <div class="flex items-start">
                    <span class="text-2xl mr-3">${insight.icon ?? ''}</span>
                    <div>
                        <h4 class="font-bold ${palette.title} mb-2">${insight.title ?? ''}</h4>
                        ${insight.content ? `<p class="text-sm ${palette.text} mb-2">${insight.content}</p>` : ''}
                        ${insight.priority ? `<p class="text-sm ${palette.text}"><strong>Priorit√†:</strong> ${insight.priority}</p>` : ''}
                        ${insight.recommendation ? `<p class="text-sm ${palette.text}"><strong>Raccomandazione:</strong> ${insight.recommendation}</p>` : ''}
                        ${bullets}
                        ${plan}
                    </div>
                </div>
            `;
            return wrap;
        };

        const hydrateQualityInsights = () => {
            const qualityReport = /*[[${qualityInsightsData}]]*/ {};
            const container = document.getElementById('qualityInsightsContainer');
            if (!container || !qualityReport) return;

            const insights = generateQualityInsights(qualityReport);
            container.innerHTML = '';
            insights.forEach(insight => container.appendChild(renderInsight(insight)));
        };

        // Render quality insights
        hydrateQualityInsights();

        const riskRules = {
            colors: {
                semantic: {
                    red: '#EF4444',
                    orange: '#F97316',
                    amber: '#F59E0B',
                    blue: '#3B82F6',
                    green: '#10B981',
                    purple: '#8B5CF6',
                    gray: '#6B7280'
                },
                sector: {
                    CORPORATE: '#3B82F6',
                    BANK: '#10B981',
                    INSURANCE: '#8B5CF6'
                },
                sectorBorder: {
                    CORPORATE: '#2563EB',
                    BANK: '#059669',
                    INSURANCE: '#7C3AED'
                },
                rank: {
                    1: '#EF4444',
                    2: '#F97316',
                    3: '#F59E0B',
                    default: '#3B82F6',
                    low: '#6B7280'
                },
                // NOTE: Purple (#8B5CF6) is reserved for INSURANCE only.
                fallbackPalette: ['#3B82F6', '#10B981', '#F59E0B', '#F97316', '#EF4444', '#6B7280']
            },
            statusBadges: {
                CONFORME: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-600' },
                'LIMITE SUPERATO': { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-600' },
                WARNING: { bg: 'bg-amber-100', text: 'text-amber-800', border: 'border-amber-600' },
                INFO: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-600' }
            },
            format: {
                eur: (value) => '‚Ç¨' + (value ?? 0).toLocaleString('it-IT'),
                eurMillions: (value) => '‚Ç¨' + ((value ?? 0) / 1000000).toFixed(1) + 'M'
            }
        };

        const normalizeSector = (label) => (label ?? '').toString().trim().toUpperCase();
        const resolveSectorKey = (label) => {
            const normalized = normalizeSector(label);
            if (normalized.includes('INSURANCE') || normalized.includes('ASSIC') || normalized === 'S.128') return 'INSURANCE';
            if (normalized.includes('BANK') || normalized.includes('BANCA') || normalized.startsWith('S.12')) return 'BANK';
            if (normalized.includes('CORPORATE') || normalized.includes('IMPRES') || normalized === 'S.11') return 'CORPORATE';
            return null;
        };

        const sectorColor = (label, index) => {
            const key = resolveSectorKey(label);
            if (key) return riskRules.colors.sector[key];
            return riskRules.colors.fallbackPalette[index % riskRules.colors.fallbackPalette.length];
        };

        const sectorBorderColor = (label, index) => {
            const key = resolveSectorKey(label);
            if (key) return riskRules.colors.sectorBorder[key];
            // Default border: slightly darker tone (reuse palette index)
            return riskRules.colors.fallbackPalette[index % riskRules.colors.fallbackPalette.length];
        };

        const top10BarColor = ({ sectorLabel, limitExceeded }, index) => {
            // Rule 2 (sector consistency) takes precedence when sector is known.
            const key = resolveSectorKey(sectorLabel);
            if (key) return riskRules.colors.sector[key];

            // Rule 3 (status): violations are always red.
            if (limitExceeded) return riskRules.colors.semantic.red;

            // Rule 1 (risk level by rank)
            if (index === 0) return riskRules.colors.semantic.red;
            if (index === 1) return riskRules.colors.semantic.orange;
            if (index === 2) return riskRules.colors.semantic.amber;
            if (index >= 6) return riskRules.colors.semantic.gray;
            return riskRules.colors.semantic.blue;
        };

        // Risk sector charts (pie + bar)
        const sectorData = /*[[${sectorChartData}]]*/ {};
        const sectorLabels = (sectorData && sectorData.labels) ? sectorData.labels : [];
        const sectorValues = (sectorData && sectorData.values) ? sectorData.values : [];
        const sectorColors = sectorLabels.map((l, i) => sectorColor(l, i));
        const sectorBorderColors = sectorLabels.map((l, i) => sectorBorderColor(l, i));

        const sectorPieEl = document.getElementById('sectorPieChart');
        if (sectorPieEl) {
            new Chart(sectorPieEl.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        data: sectorValues,
                        backgroundColor: sectorColors,
                        borderColor: sectorBorderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = (context.dataset.data || []).reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return label + ': ' + riskRules.format.eur(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        const sectorBarEl = document.getElementById('sectorBarChart');
        if (sectorBarEl) {
            new Chart(sectorBarEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        label: 'Esposizione (EUR)',
                        data: sectorValues,
                        backgroundColor: sectorColors,
                        borderColor: sectorBorderColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return riskRules.format.eur(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return riskRules.format.eurMillions(value); } }
                        }
                    }
                }
            });
        }

        // Top 10 exposures chart
        const topExposuresData = /*[[${topExposuresChartData}]]*/ {};
        const topLabels = (topExposuresData && topExposuresData.labels) ? topExposuresData.labels : [];
        const topValues = (topExposuresData && topExposuresData.values) ? topExposuresData.values : [];
        const topSectors = (topExposuresData && topExposuresData.sectors) ? topExposuresData.sectors : [];
        const topLimitExceeded = (topExposuresData && topExposuresData.limitExceeded) ? topExposuresData.limitExceeded : [];
        const topColors = topLabels.map((_, i) => top10BarColor({
            sectorLabel: topSectors[i],
            limitExceeded: Boolean(topLimitExceeded[i])
        }, i));

        const top10El = document.getElementById('top10Chart');
        if (top10El) {
            new Chart(top10El.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: topLabels,
                    datasets: [{
                        label: 'Importo (EUR)',
                        data: topValues,
                        backgroundColor: topColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return riskRules.format.eur(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return riskRules.format.eurMillions(value); } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
