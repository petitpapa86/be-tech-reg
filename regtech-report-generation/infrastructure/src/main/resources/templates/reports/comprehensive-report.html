<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Risk Analysis Report</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        @media print {
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none; }
            .page-break { page-break-before: always; }
        }
        
        .quality-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: bold;
            font-size: 1.25rem;
        }
        
        .quality-badge.grade-a { background-color: #10b981; color: white; }
        .quality-badge.grade-b { background-color: #84cc16; color: white; }
        .quality-badge.grade-c { background-color: #eab308; color: white; }
        .quality-badge.grade-d { background-color: #f97316; color: white; }
        .quality-badge.grade-e { background-color: #ef4444; color: white; }
        .quality-badge.grade-f { background-color: #dc2626; color: white; }
        
        .compliance-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .compliance-badge.compliant { background-color: #10b981; color: white; }
        .compliance-badge.non-compliant { background-color: #ef4444; color: white; }
        .compliance-badge.warning { background-color: #f59e0b; color: white; }
        
        .summary-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .summary-card-title {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .summary-card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #111827;
        }
        
        .dimension-bar {
            height: 1.5rem;
            border-radius: 0.25rem;
            transition: width 0.3s ease;
        }
        
        .recommendation-section {
            border-left: 4px solid;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f9fafb;
            border-radius: 0.25rem;
        }
        
        .recommendation-section.red { border-color: #ef4444; }
        .recommendation-section.yellow { border-color: #f59e0b; }
        .recommendation-section.green { border-color: #10b981; }
        .recommendation-section.blue { border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="max-w-7xl mx-auto p-8">

        <!-- Risk / Large Exposures (Italian layout) -->
        <section>
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="border-b-4 border-blue-600 pb-4 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                RAPPORTO GRANDI RISCHI
                            </h1>
                            <p class="text-lg text-gray-600">
                                Circolare n. 285 del 17 dicembre 2013 - Banca d'Italia
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-blue-600 text-white px-4 py-2 rounded-lg">
                                <p class="text-sm font-semibold">Data Riferimento</p>
                                <p class="text-xl font-bold" th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2024-09-30</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">BANCA</h3>
                        <p class="text-xl font-bold text-gray-900" th:text="${metadata.bankName}">Banca</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-semibold">Codice ABI:</span> <span th:text="${metadata.bankId.value()}">08081</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Report ID:</span> <span class="font-mono" th:text="${metadata.batchId.value()}">report_id</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Generato:</span> <span th:text="${#temporals.format(metadata.generatedAt, 'dd/MM/yyyy HH:mm:ss')}">01/01/2024 10:00:00</span></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">PATRIMONIO DI VIGILANZA</h3>
                        <div class="space-y-2">
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Fondi Propri Totali</p>
                                <p class="text-lg font-bold text-gray-900" th:text="${calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Capitale Tier 1</p>
                                <p class="text-lg font-bold text-gray-900" th:text="${calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                <p class="text-xs text-blue-800 font-semibold">Capitale Eleggibile Grandi Rischi</p>
                                <p class="text-lg font-bold text-blue-900" th:text="${calculationResults.tierOneCapital.toFormattedString()}">‚Ç¨ 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="largeExposures=${calculationResults.largeExposures},
                          largeCount=${calculationResults.largeExposuresCount},
                          totalPctCapital=${(calculationResults.tierOneCapital.value().doubleValue() > 0) ? (calculationResults.totalAmount.value().doubleValue() * 100.0 / calculationResults.tierOneCapital.value().doubleValue()) : 0.0}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Riepilogo Esecutivo
                </h2>

                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Grandi Esposizioni</p>
                        <p class="text-4xl font-bold mt-2" th:text="${largeCount}">0</p>
                        <p class="text-xs mt-2 opacity-75">‚â• 10% capitale eleggibile</p>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Importo Totale</p>
                        <p class="text-2xl font-bold mt-2" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(calculationResults.totalAmount.value().doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(totalPctCapital, 1, 1)}">0.0</span>% capitale</p>
                    </div>

                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Superamento Limite</p>
                        <p class="text-4xl font-bold mt-2" th:text="${calculationResults.limitBreaches}">0</p>
                        <p class="text-xs mt-2 opacity-75">&gt; 25% capitale eleggibile</p>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Settori Coinvolti</p>
                        <p class="text-4xl font-bold mt-2" th:text="${riskConcentration.sectorsInvolved}">0</p>
                        <p class="text-xs mt-2 opacity-75">Diversificazione settoriale</p>
                    </div>
                </div>
            </div>

            <!-- Sector Distribution -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Distribuzione Settoriale
                </h2>

                <div class="grid grid-cols-2 gap-8">
                    <div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Ripartizione per Settore</h3>
                            <canvas id="sectorPieChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 text-center">Esposizione per Settore (EUR)</h3>
                            <canvas id="sectorBarChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sector Details Table (dynamic) -->
                <div class="mt-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Settore</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">N. Esposizioni</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">Importo Totale</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">% su Totale</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase">% Capitale</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="row : ${riskSectorRows}" class="hover:bg-gray-50">
                                <td class="px-4 py-3">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                          th:classappend="${row.theme == 'bank' ? ' bg-green-100 text-green-800' : row.theme == 'insurance' ? ' bg-purple-100 text-purple-800' : row.theme == 'other' ? ' bg-gray-100 text-gray-800' : ' bg-blue-100 text-blue-800'}"
                                          th:text="${row.label}">SETTORE</span>
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-medium" th:text="${row.count}">0</td>
                                <td class="px-4 py-3 text-right text-sm font-bold" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(row.amountEur, 1, 2)}">‚Ç¨ 0.00</td>
                                <td class="px-4 py-3 text-right text-sm font-semibold text-blue-600">
                                    <span th:text="${#numbers.formatDecimal(row.percentOfTotal, 1, 2)}">0.00</span>%
                                </td>
                                <td class="px-4 py-3 text-right text-sm font-semibold">
                                    <span th:text="${#numbers.formatDecimal(row.percentOfCapital, 1, 2)}">0.00</span>%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top 10 Exposures -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Top 10 Esposizioni
                </h2>

                <div class="mb-6">
                    <canvas id="top10Chart" style="max-height: 400px;"></canvas>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div th:each="card : ${riskTopExposureCards}"
                         class="p-4 rounded-lg"
                         th:classappend="${card.theme == 'rank1' ? ' bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500' : card.theme == 'rank2' ? ' bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-500' : card.theme == 'rank3' ? ' bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-500' : card.theme == 'bank' ? ' bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500' : card.theme == 'insurance' ? ' bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-500' : card.theme == 'other' ? ' bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400' : ' bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-xs font-semibold uppercase"
                                   th:text="${(card.medal != null and !#strings.isEmpty(card.medal) ? card.medal + ' ' : '') + card.rank + '¬∞ - ' + card.counterpartyName}">ü•á 1¬∞ - CONTROPARTE</p>
                                <p class="text-2xl font-bold mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(card.amountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                                <p class="text-sm mt-1" th:text="${#numbers.formatDecimal(card.percentOfCapital, 1, 2) + '% del capitale ‚Ä¢ ' + card.sectorLabel}">0.00% del capitale</p>
                            </div>
                            <div class="text-right" th:if="${card.rank <= 3}">
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${card.limitExceeded ? ' bg-red-600 text-white' : ' bg-green-600 text-white'}"
                                      th:text="${card.limitExceeded ? '‚ö†Ô∏è LIMITE SUPERATO' : '‚úì CONFORME'}">‚úì CONFORME</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Concentration Metrics -->
                <div class="mt-6 grid grid-cols-3 gap-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-red-800 uppercase">Concentrazione Top 3</p>
                        <p class="text-2xl font-bold text-red-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.top3AmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-red-700"><span th:text="${#numbers.formatDecimal(riskConcentration.top3PercentOfTotal, 1, 2)}">0.00</span>% del totale esposizioni</p>
                    </div>

                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-orange-800 uppercase">Concentrazione Top 5</p>
                        <p class="text-2xl font-bold text-orange-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.top5AmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-orange-700"><span th:text="${#numbers.formatDecimal(riskConcentration.top5PercentOfTotal, 1, 2)}">0.00</span>% del totale esposizioni</p>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-xs font-semibold text-blue-800 uppercase">Esposizione Media</p>
                        <p class="text-2xl font-bold text-blue-900 mt-1" th:text="${'‚Ç¨ ' + #numbers.formatDecimal(riskConcentration.avgExposureAmountEur.doubleValue() / 1000000.0, 1, 1) + 'M'}">‚Ç¨ 0.0M</p>
                        <p class="text-sm text-blue-700"><span th:text="${#numbers.formatDecimal(riskConcentration.avgExposurePercentOfCapital, 1, 2)}">0.00</span>% del capitale eleggibile</p>
                    </div>
                </div>
            </div>

            <!-- Large Exposures Table -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Dettaglio Grandi Esposizioni
                </h2>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">N.</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Controparte</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Settore</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">Importo (EUR)</th>
                                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider">% Capitale</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr th:each="exposure,stat : ${calculationResults.largeExposures}" class="hover:bg-gray-50">
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${stat.index + 1}">1</td>
                                <td class="px-4 py-4 text-sm text-gray-900">
                                    <div class="font-semibold" th:text="${exposure.counterpartyName}">CONTROPARTE</div>
                                    <div class="text-xs text-gray-500 font-mono" th:text="${exposure.leiCodeOrDefault}">LEI</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800"
                                          th:text="${exposure.sectorCode}">S.11</span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-right font-medium text-gray-900"
                                    th:text="${'‚Ç¨ ' + #numbers.formatDecimal(exposure.amountEur, 1, 2)}">‚Ç¨ 0.00</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-right font-bold text-gray-900"
                                    th:text="${#numbers.formatDecimal(exposure.percentageOfCapital, 1, 2) + '%'}">0.00%</td>
                                <td class="px-4 py-4 whitespace-nowrap text-center">
                                    <span class="px-3 py-1 text-xs font-bold rounded-full"
                                          th:classappend="${exposure.exceedsLimit ? ' bg-red-100 text-red-800' : ' bg-green-100 text-green-800'}"
                                          th:text="${exposure.exceedsLimit ? 'LIMITE SUPERATO' : 'CONFORME'}">CONFORME</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Compliance Notes -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="eligible=${calculationResults.tierOneCapital.toFormattedString()}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Note di Conformit√†
                </h2>

                <div class="space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <h4 class="font-bold text-blue-900 mb-2">üìã Soglia Grande Esposizione</h4>
                        <p class="text-sm text-blue-800">
                            Un'esposizione √® considerata "grande rischio" quando rappresenta il <strong>10% o pi√π</strong>
                            del capitale eleggibile della banca (<span th:text="${eligible}">‚Ç¨ 0.00</span>).
                        </p>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
                        <h4 class="font-bold text-amber-900 mb-2">‚ö†Ô∏è Limite Legale Generale</h4>
                        <p class="text-sm text-amber-800">
                            Il limite generale per le grandi esposizioni √® del <strong>25%</strong> del capitale eleggibile.
                            Esposizioni superiori richiedono esenzioni specifiche o autorizzazioni supervisorie.
                        </p>
                    </div>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4">
                        <h4 class="font-bold text-green-900 mb-2">‚úì Esenzioni Applicabili</h4>
                        <p class="text-sm text-green-800 mb-2">
                            Le seguenti esenzioni possono essere applicate secondo la normativa:
                        </p>
                        <ul class="list-disc list-inside text-sm text-green-800 space-y-1">
                            <li>Titoli di Stato (esenti da limite)</li>
                            <li>Covered bond con garanzia statale (limite 500%)</li>
                            <li>Esposizioni verso enti creditizi della stessa rete</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
            </div>
        </section>
        
        <!-- Data Quality Section (layout aligned to provided Italian Tailwind template) -->
        <section class="page-break">

            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <div class="border-b-4 border-purple-600 pb-4 mb-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                                RAPPORTO DATA QUALITY
                            </h1>
                            <p class="text-lg text-gray-600">
                                BCBS 239 - Principi per l'aggregazione dei dati di rischio e l'informativa di rischio
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="bg-purple-600 text-white px-4 py-2 rounded-lg">
                                <p class="text-sm font-semibold">Data Riferimento</p>
                                <p class="text-xl font-bold" th:text="${#temporals.format(metadata.reportingDate.value(), 'yyyy-MM-dd')}">2025-11-17</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">BANCA</h3>
                        <p class="text-xl font-bold text-gray-900" th:text="${metadata.bankName}">Banca Cooperativa Trentina SpA</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm text-gray-600"><span class="font-semibold">Bank ID:</span> <span th:text="${metadata.bankId.value()}">daa4a072</span></p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Report ID:</span>
                                <span th:text="${'qr_' + metadata.batchId.value()}" class="font-mono">qr_4c28380f-5fc2-4034-bffd-4f21038c0391</span>
                            </p>
                            <p class="text-sm text-gray-600"><span class="font-semibold">Batch ID:</span> <span th:text="${qualityResults.batchId.value()}" class="font-mono">batch_20251117_221306_e86335e4</span></p>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-sm font-semibold text-gray-500 mb-2">STATO VALIDAZIONE</h3>
                        <div class="space-y-2">
                            <div class="bg-red-50 p-3 rounded border border-red-200">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-red-800 font-semibold">Stato Conformit√†</p>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full"
                                          th:classappend="${qualityResults.complianceStatus.name() == 'COMPLIANT' ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}"
                                          th:text="${qualityResults.complianceStatus.name() == 'COMPLIANT' ? 'CONFORME' : 'NON CONFORME'}">
                                        NON CONFORME
                                    </span>
                                </div>
                            </div>
                            <div class="bg-red-50 p-3 rounded border border-red-200">
                                <div class="flex justify-between items-center">
                                    <p class="text-xs text-red-800 font-semibold">Livello di Attenzione</p>
                                    <span class="px-3 py-1 text-xs font-bold rounded-full"
                                          th:classappend="${qualityResults.attentionLevel.name() == 'LOW' ? ' bg-green-600 text-white' : qualityResults.attentionLevel.name() == 'MEDIUM' ? ' bg-yellow-600 text-white' : ' bg-red-600 text-white'}"
                                          th:text="${qualityResults.attentionLevel.name() == 'CRITICAL' ? 'IMMEDIATO' : qualityResults.attentionLevel.name() == 'HIGH' ? 'ALTO' : qualityResults.attentionLevel.name() == 'MEDIUM' ? 'MEDIO' : 'BASSO'}">
                                        IMMEDIATO
                                    </span>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="text-xs text-gray-600">Tempo di Elaborazione</p>
                                <p class="text-lg font-bold text-gray-900">1 ms</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall Score -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Punteggio Complessivo
                </h2>

                <div class="grid grid-cols-5 gap-4 mb-6"
                     th:with="validRate=${(qualityResults.totalExposures != null and qualityResults.totalExposures > 0) ? ((qualityResults.validExposures * 100.0) / qualityResults.totalExposures) : 0.0},
                              errorRate=${(qualityResults.totalExposures != null and qualityResults.totalExposures > 0) ? ((qualityResults.totalErrors * 100.0) / qualityResults.totalExposures) : 0.0}">
                    <div class="col-span-2 bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-8 text-white">
                        <p class="text-sm font-semibold opacity-90 mb-2">QUALITY SCORE</p>
                        <div class="flex items-end space-x-4">
                            <p class="text-6xl font-bold"><span th:text="${#numbers.formatDecimal(qualityResults.overallScore, 1, 1)}">46.0</span>%</p>
                            <p class="text-4xl font-bold pb-2 opacity-90" th:text="${qualityResults.overallGrade.name()}">F</p>
                        </div>
                        <p class="text-xs mt-3 opacity-75 uppercase tracking-wide">POOR - Requires Immediate Action</p>
                    </div>

                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Esposizioni Totali</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.totalExposures}">5</p>
                        <p class="text-xs mt-2 opacity-75">Analizzate</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Esposizioni Valide</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.validExposures}">0</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(validRate, 1, 1)}">0.0</span>% validation rate</p>
                    </div>

                    <div class="bg-gradient-to-br from-red-600 to-red-700 rounded-lg p-6 text-white">
                        <p class="text-sm font-semibold opacity-90">Errori Totali</p>
                        <p class="text-4xl font-bold mt-2" th:text="${qualityResults.totalErrors}">16</p>
                        <p class="text-xs mt-2 opacity-75"><span th:text="${#numbers.formatDecimal(errorRate, 1, 1)}">100.0</span>% error rate</p>
                    </div>
                </div>
            </div>

            <!-- Dimension Scores -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="cpl=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS)},
                          acc=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY)},
                          con=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY)},
                          tim=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS)},
                          uni=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS)},
                          val=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY)},
                          cplErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS).count : 0},
                          accErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY).count : 0},
                          conErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY).count : 0},
                          timErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS).count : 0},
                          uniErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).UNIQUENESS).count : 0},
                          valErr=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).VALIDITY).count : 0}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Punteggi per Dimensione di Qualit√†
                </h2>

                <div class="space-y-4">
                    <!-- Completeness -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Completezza (Completeness)</h4>
                                <p class="text-sm text-gray-600">Tutti i dati richiesti sono presenti e popolati</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-red-600" th:text="${#numbers.formatDecimal((cpl != null ? cpl : 0), 1, 1)} + '%'"><span>0.0%</span></span>
                                <p class="text-xs text-red-600 font-semibold"><span th:text="${cplErr}">10</span> ERRORI</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-red-600 h-4 rounded-full" th:style="${'width: ' + (cpl != null ? cpl : 0) + '%'}" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Accuracy -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Accuratezza (Accuracy)</h4>
                                <p class="text-sm text-gray-600">I dati riflettono correttamente la realt√†</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-red-600" th:text="${#numbers.formatDecimal((acc != null ? acc : 0), 1, 1)} + '%'"><span>0.0%</span></span>
                                <p class="text-xs text-red-600 font-semibold"><span th:text="${accErr}">5</span> ERRORI</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-red-600 h-4 rounded-full" th:style="${'width: ' + (acc != null ? acc : 0) + '%'}" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Consistency -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Coerenza (Consistency)</h4>
                                <p class="text-sm text-gray-600">I dati sono uniformi tra diverse fonti e nel tempo</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-amber-600" th:text="${#numbers.formatDecimal((con != null ? con : 0), 1, 1)} + '%'"><span>80.0%</span></span>
                                <p class="text-xs text-amber-600 font-semibold"><span th:text="${conErr}">1</span> ERRORE</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-amber-500 h-4 rounded-full" th:style="${'width: ' + (con != null ? con : 0) + '%'}" style="width: 80%"></div>
                        </div>
                    </div>

                    <!-- Timeliness -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Tempestivit√† (Timeliness)</h4>
                                <p class="text-sm text-gray-600">I dati sono aggiornati e disponibili quando necessari</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-green-600" th:text="${#numbers.formatDecimal((tim != null ? tim : 0), 1, 1)} + '%'"><span>100.0%</span></span>
                                <p class="text-xs text-green-600 font-semibold"><span th:text="${timErr}">0</span> ERRORI</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-600 h-4 rounded-full" th:style="${'width: ' + (tim != null ? tim : 0) + '%'}" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Uniqueness -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Unicit√† (Uniqueness)</h4>
                                <p class="text-sm text-gray-600">Non ci sono duplicazioni nei dati</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-green-600" th:text="${#numbers.formatDecimal((uni != null ? uni : 0), 1, 1)} + '%'"><span>100.0%</span></span>
                                <p class="text-xs text-green-600 font-semibold"><span th:text="${uniErr}">0</span> ERRORI</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-600 h-4 rounded-full" th:style="${'width: ' + (uni != null ? uni : 0) + '%'}" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Validity -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <div>
                                <h4 class="text-lg font-bold text-gray-900">Validit√† (Validity)</h4>
                                <p class="text-sm text-gray-600">I dati rispettano le regole di business e i formati attesi</p>
                            </div>
                            <div class="text-right">
                                <span class="text-3xl font-bold text-green-600" th:text="${#numbers.formatDecimal((val != null ? val : 0), 1, 1)} + '%'"><span>100.0%</span></span>
                                <p class="text-xs text-green-600 font-semibold"><span th:text="${valErr}">0</span> ERRORI</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div class="bg-green-600 h-4 rounded-full" th:style="${'width: ' + (val != null ? val : 0) + '%'}" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Distribution -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="cplCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS).count : 0},
                          accCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY).count : 0},
                          conCnt=${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY).count : 0},
                          maxCnt=${(cplCnt >= accCnt and cplCnt >= conCnt) ? cplCnt : (accCnt >= conCnt ? accCnt : conCnt)}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Distribuzione Errori per Dimensione
                </h2>

                <div class="grid grid-cols-3 gap-6">
                    <div class="bg-red-50 rounded-lg p-6 border-2 border-red-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-semibold text-red-800">COMPLETENESS</p>
                                <p class="text-xs text-red-600 mt-1">Dimensione pi√π problematica</p>
                            </div>
                            <span class="text-3xl font-bold text-red-600" th:text="${cplCnt}">10</span>
                        </div>
                        <div class="w-full bg-red-200 rounded-full h-3">
                            <div class="bg-red-600 h-3 rounded-full"
                                 th:style="${'width: ' + (maxCnt > 0 ? ((cplCnt * 100.0) / maxCnt) : 0) + '%'}" style="width: 100%"></div>
                        </div>
                        <p class="text-xs text-red-700 mt-2"><span th:text="${qualityResults.totalErrors > 0 ? #numbers.formatDecimal((cplCnt * 100.0) / qualityResults.totalErrors, 1, 1) : '0.0'}">62.5</span>% degli errori totali</p>
                    </div>

                    <div class="bg-orange-50 rounded-lg p-6 border-2 border-orange-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-semibold text-orange-800">ACCURACY</p>
                                <p class="text-xs text-orange-600 mt-1">Seconda dimensione critica</p>
                            </div>
                            <span class="text-3xl font-bold text-orange-600" th:text="${accCnt}">5</span>
                        </div>
                        <div class="w-full bg-orange-200 rounded-full h-3">
                            <div class="bg-orange-600 h-3 rounded-full"
                                 th:style="${'width: ' + (maxCnt > 0 ? ((accCnt * 100.0) / maxCnt) : 0) + '%'}" style="width: 50%"></div>
                        </div>
                        <p class="text-xs text-orange-700 mt-2"><span th:text="${qualityResults.totalErrors > 0 ? #numbers.formatDecimal((accCnt * 100.0) / qualityResults.totalErrors, 1, 1) : '0.0'}">31.3</span>% degli errori totali</p>
                    </div>

                    <div class="bg-yellow-50 rounded-lg p-6 border-2 border-yellow-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-sm font-semibold text-yellow-800">CONSISTENCY</p>
                                <p class="text-xs text-yellow-600 mt-1">Errori minori</p>
                            </div>
                            <span class="text-3xl font-bold text-yellow-600" th:text="${conCnt}">1</span>
                        </div>
                        <div class="w-full bg-yellow-200 rounded-full h-3">
                            <div class="bg-yellow-600 h-3 rounded-full"
                                 th:style="${'width: ' + (maxCnt > 0 ? ((conCnt * 100.0) / maxCnt) : 0) + '%'}" style="width: 10%"></div>
                        </div>
                        <p class="text-xs text-yellow-700 mt-2"><span th:text="${qualityResults.totalErrors > 0 ? #numbers.formatDecimal((conCnt * 100.0) / qualityResults.totalErrors, 1, 1) : '0.0'}">6.3</span>% degli errori totali</p>
                    </div>
                </div>
            </div>

            <!-- Quality Insights -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Analisi e Raccomandazioni
                </h2>

                <div class="space-y-4">
                    <div class="bg-red-50 border-l-4 border-red-500 p-4">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üö®</span>
                            <div>
                                <h4 class="font-bold text-red-900 mb-2">Situazione Critica - Azione Immediata Richiesta</h4>
                                <p class="text-sm text-red-800 mb-2">
                                    Il punteggio complessivo di qualit√† del <strong><span th:text="${#numbers.formatDecimal(qualityResults.overallScore, 0, 0)}">46</span>%</strong> indica una situazione critica che richiede
                                    intervento immediato. Tutte le <span th:text="${qualityResults.totalExposures}">5</span> esposizioni analizzate presentano errori di validazione.
                                </p>
                                <p class="text-sm text-red-800">
                                    <strong>Priorit√†:</strong> Affrontare immediatamente i problemi di completezza e accuratezza dei dati.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üìä</span>
                            <div>
                                <h4 class="font-bold text-orange-900 mb-2">Problemi di Completezza dei Dati</h4>
                                <p class="text-sm text-orange-800 mb-2">
                                    La dimensione <strong>Completeness</strong> mostra il punteggio pi√π basso (<strong><span th:text="${#numbers.formatDecimal((qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) : 0), 0, 0)}">0</span>%</strong>) con
                                    <span th:text="${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS).count : 0}">10</span> errori identificati.
                                    Questo indica che campi obbligatori mancano o non sono popolati correttamente.
                                </p>
                                <p class="text-sm text-orange-800">
                                    <strong>Raccomandazione:</strong> Verificare i processi di data entry e assicurarsi che tutti i campi
                                    obbligatori siano correttamente valorizzati nei sistemi di origine.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-500 p-4">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üéØ</span>
                            <div>
                                <h4 class="font-bold text-amber-900 mb-2">Problemi di Accuratezza</h4>
                                <p class="text-sm text-amber-800 mb-2">
                                    La dimensione <strong>Accuracy</strong> presenta anch'essa un punteggio dello <strong><span th:text="${#numbers.formatDecimal((qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) : 0), 0, 0)}">0</span>%</strong> con
                                    <span th:text="${qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY) != null ? qualityResults.errorDistributionByDimension.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY).count : 0}">5</span> errori.
                                    I dati potrebbero non riflettere correttamente le informazioni effettive delle esposizioni.
                                </p>
                                <p class="text-sm text-amber-800">
                                    <strong>Raccomandazione:</strong> Implementare controlli di riconciliazione tra i sistemi sorgente
                                    e il data warehouse per garantire l'accuratezza delle informazioni.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-green-50 border-l-4 border-green-500 p-4">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">‚úÖ</span>
                            <div>
                                <h4 class="font-bold text-green-900 mb-2">Aspetti Positivi</h4>
                                <p class="text-sm text-green-800 mb-2">
                                    Le dimensioni <strong>Timeliness</strong>, <strong>Uniqueness</strong> e <strong>Validity</strong>
                                    mostrano punteggi del 100%, indicando che:
                                </p>
                                <ul class="list-disc list-inside text-sm text-green-800 space-y-1 ml-4">
                                    <li>I dati sono aggiornati e disponibili nei tempi richiesti</li>
                                    <li>Non ci sono duplicazioni nei record</li>
                                    <li>I formati dei dati rispettano le regole di validazione</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                        <div class="flex items-start">
                            <span class="text-2xl mr-3">üìã</span>
                            <div>
                                <h4 class="font-bold text-blue-900 mb-2">Piano d'Azione Consigliato</h4>
                                <p class="text-sm text-blue-800 mb-2"><strong>Breve Termine (1-2 settimane):</strong></p>
                                <ul class="list-disc list-inside text-sm text-blue-800 space-y-1 ml-4 mb-3">
                                    <li>Analisi dettagliata degli errori di completezza e accuratezza</li>
                                    <li>Identificazione dei campi mancanti o errati</li>
                                    <li>Correzione manuale delle esposizioni critiche</li>
                                </ul>
                                <p class="text-sm text-blue-800 mb-2"><strong>Medio Termine (1-3 mesi):</strong></p>
                                <ul class="list-disc list-inside text-sm text-blue-800 space-y-1 ml-4 mb-3">
                                    <li>Implementazione di controlli automatici nei sistemi sorgente</li>
                                    <li>Sviluppo di processi di riconciliazione automatica</li>
                                    <li>Formazione degli operatori sui requisiti di qualit√†</li>
                                </ul>
                                <p class="text-sm text-blue-800 mb-2"><strong>Lungo Termine (3-6 mesi):</strong></p>
                                <ul class="list-disc list-inside text-sm text-blue-800 space-y-1 ml-4">
                                    <li>Implementazione di data governance framework</li>
                                    <li>Automazione completa dei controlli di qualit√†</li>
                                    <li>Monitoraggio continuo e reporting automatico</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BCBS 239 Compliance -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6"
                 th:with="acc=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).ACCURACY)},
                          cpl=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).COMPLETENESS)},
                          tim=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).TIMELINESS)},
                          ada=${qualityResults.dimensionScores.get(T(com.bcbs239.regtech.reportgeneration.domain.shared.valueobjects.QualityDimension).CONSISTENCY)}">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Conformit√† BCBS 239
                </h2>

                <div class="space-y-4">
                    <div class="bg-purple-50 border-l-4 border-purple-500 p-4">
                        <h4 class="font-bold text-purple-900 mb-2">üìò Principi BCBS 239</h4>
                        <p class="text-sm text-purple-800 mb-3">
                            Il Basel Committee on Banking Supervision ha stabilito 14 principi fondamentali per l'aggregazione
                            dei dati di rischio e l'informativa di rischio. I principi relativi alla qualit√† dei dati includono:
                        </p>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 3: Accuratezza e Integrit√†</p>
                                <p class="text-xs text-purple-800">I dati devono essere accurati e affidabili</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 4: Completezza</p>
                                <p class="text-xs text-purple-800">I dati devono essere completi e disponibili</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 5: Tempestivit√†</p>
                                <p class="text-xs text-purple-800">I dati devono essere aggiornati e disponibili on-demand</p>
                            </div>
                            <div class="bg-white p-3 rounded border border-purple-200">
                                <p class="text-xs font-bold text-purple-900 mb-1">Principio 6: Adattabilit√†</p>
                                <p class="text-xs text-purple-800">I sistemi devono essere flessibili per nuove esigenze</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-900 mb-3">Valutazione Conformit√† per Principio</h4>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">Principio 3 - Accuratezza e Integrit√†</span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${(acc != null and acc >= 90) ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}"
                                      th:text="${(acc != null and acc >= 90) ? 'CONFORME' : 'NON CONFORME'}">NON CONFORME</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">Principio 4 - Completezza</span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${(cpl != null and cpl >= 90) ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}"
                                      th:text="${(cpl != null and cpl >= 90) ? 'CONFORME' : 'NON CONFORME'}">NON CONFORME</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">Principio 5 - Tempestivit√†</span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${(tim != null and tim >= 90) ? ' bg-green-100 text-green-800' : ' bg-red-100 text-red-800'}"
                                      th:text="${(tim != null and tim >= 90) ? 'CONFORME' : 'NON CONFORME'}">CONFORME</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-700">Principio 6 - Adattabilit√†</span>
                                <span class="px-3 py-1 text-xs font-bold rounded-full"
                                      th:classappend="${(ada != null and ada >= 90) ? ' bg-green-100 text-green-800' : (ada != null and ada >= 70) ? ' bg-yellow-100 text-yellow-800' : ' bg-red-100 text-red-800'}"
                                      th:text="${(ada != null and ada >= 90) ? 'CONFORME' : (ada != null and ada >= 70) ? 'PARZIALE' : 'NON CONFORME'}">PARZIALE</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Details -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b-2 border-gray-200 pb-2">
                    Dettagli Tecnici
                </h2>

                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Informazioni Report</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Report ID:</span>
                                <span class="font-mono text-gray-900" th:text="${'qr_' + metadata.batchId.value()}">qr_4c28380f-5fc2-4034...</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Batch ID:</span>
                                <span class="font-mono text-gray-900" th:text="${qualityResults.batchId.value()}">batch_20251117_221306...</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Bank ID:</span>
                                <span class="font-mono text-gray-900" th:text="${qualityResults.bankId.value()}">daa4a072</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Status:</span>
                                <span class="font-semibold text-green-600">COMPLETED</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Metriche di Elaborazione</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Tempo di Elaborazione:</span>
                                <span class="font-semibold text-gray-900">1 ms</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Data Creazione:</span>
                                <span class="font-semibold text-gray-900" th:text="${#temporals.format(qualityResults.timestamp, 'yyyy-MM-dd HH:mm:ss ''UTC''')}">2025-11-17 21:13:12 UTC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Data Aggiornamento:</span>
                                <span class="font-semibold text-gray-900" th:text="${#temporals.format(qualityResults.timestamp, 'yyyy-MM-dd HH:mm:ss ''UTC''')}">2025-11-17 21:13:12 UTC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Details URI:</span>
                                <span class="font-mono text-xs text-gray-900">s3://local/quality/...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="bg-gray-100 rounded-lg p-6 text-center text-sm text-gray-600">
                <p class="mb-2">
                    <strong>Rapporto generato da BCBS 239 Data Quality Engine</strong> - Template v2024.1
                </p>
                <p>
                    Generato il: <span th:text="${#temporals.format(metadata.generatedAt, 'dd/MM/yyyy')}">17/11/2025</span> alle ore <span th:text="${#temporals.format(metadata.generatedAt, 'HH:mm:ss')}">21:13:12</span>
                </p>
                <p class="mt-2 text-xs">
                    Questo rapporto √® stato generato automaticamente secondo i principi BCBS 239.
                    Per informazioni sulla normativa: <a href="https://www.bis.org/publ/bcbs239.htm" class="text-blue-600 hover:underline">www.bis.org/publ/bcbs239.htm</a>
                </p>
            </div>

            <!-- Print Button -->
            <div class="mt-6 text-center no-print">
                <button onclick="window.print()"
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-200">
                    üñ®Ô∏è Stampa Rapporto / Salva PDF
                </button>
            </div>

        </section>
        
    </div>
    
    <!-- Chart.js Scripts -->
    <script th:inline="javascript">
        const riskRules = {
            colors: {
                sector: {
                    corporate: '#3b82f6',
                    bank: '#10b981',
                    insurance: '#8b5cf6',
                    other: '#6b7280'
                },
                rank: {
                    1: '#ef4444',
                    2: '#f97316',
                    3: '#f59e0b',
                    default: '#3b82f6'
                },
                fallbackPalette: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#6b7280']
            },
            format: {
                eur: (value) => '‚Ç¨' + (value ?? 0).toLocaleString('it-IT'),
                eurMillions: (value) => '‚Ç¨' + ((value ?? 0) / 1000000).toFixed(1) + 'M'
            }
        };

        const normalizeSector = (label) => (label ?? '').toString().trim().toUpperCase();
        const sectorColor = (label, index) => {
            const normalized = normalizeSector(label);
            if (normalized.includes('BANK') || normalized.includes('BANCA')) return riskRules.colors.sector.bank;
            if (normalized.includes('INSURANCE') || normalized.includes('ASSIC')) return riskRules.colors.sector.insurance;
            if (normalized.includes('CORPORATE') || normalized.includes('IMPRES')) return riskRules.colors.sector.corporate;
            if (normalized.includes('OTHER') || normalized.includes('ALTRO')) return riskRules.colors.sector.other;
            return riskRules.colors.fallbackPalette[index % riskRules.colors.fallbackPalette.length];
        };

        // Risk sector charts (pie + bar)
        const sectorData = /*[[${sectorChartData}]]*/ {};
        const sectorLabels = (sectorData && sectorData.labels) ? sectorData.labels : [];
        const sectorValues = (sectorData && sectorData.values) ? sectorData.values : [];
        const sectorColors = sectorLabels.map((l, i) => sectorColor(l, i));

        const sectorPieEl = document.getElementById('sectorPieChart');
        if (sectorPieEl) {
            new Chart(sectorPieEl.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        data: sectorValues,
                        backgroundColor: sectorColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { font: { size: 11 }, padding: 10 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = (context.dataset.data || []).reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                    return label + ': ' + riskRules.format.eur(value) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        const sectorBarEl = document.getElementById('sectorBarChart');
        if (sectorBarEl) {
            new Chart(sectorBarEl.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: sectorLabels,
                    datasets: [{
                        label: 'Esposizione (EUR)',
                        data: sectorValues,
                        backgroundColor: sectorColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return riskRules.format.eur(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return riskRules.format.eurMillions(value); } }
                        }
                    }
                }
            });
        }

        // Top 10 exposures chart
        const topExposuresData = /*[[${topExposuresChartData}]]*/ {};
        const topLabels = (topExposuresData && topExposuresData.labels) ? topExposuresData.labels : [];
        const topValues = (topExposuresData && topExposuresData.values) ? topExposuresData.values : [];
        const topColors = topLabels.map((_, i) => riskRules.colors.rank[i + 1] || riskRules.colors.rank.default);

        const top10El = document.getElementById('top10Chart');
        if (top10El) {
            new Chart(top10El.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: topLabels,
                    datasets: [{
                        label: 'Importo (EUR)',
                        data: topValues,
                        backgroundColor: topColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return riskRules.format.eur(context.parsed.x);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { callback: function(value) { return riskRules.format.eurMillions(value); } }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
