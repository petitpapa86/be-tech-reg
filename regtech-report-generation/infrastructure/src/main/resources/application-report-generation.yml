# Report Generation Module Configuration
# Requirements: 3.1, 3.2, 12.1, 20.3, 22.1
report-generation:
  enabled: true
  
  # Storage configuration (Requirement 12.1)
  storage:
    # Storage type: 's3' for AWS S3, 'local' for filesystem
    # Default: local (for development), s3 (for production)
    type: local
    
    # Local filesystem storage configuration
    local:
      # Base directory for storing generated reports
      base-path: ./data/reports
      # Automatically create directories if they don't exist
      create-directories: true
  
  # S3 storage configuration (Requirement 12.1)
  # Production: s3://risk-analysis-production/reports/{html|xbrl}/
  # Development: s3://risk-analysis-dev/reports/{html|xbrl}/
  s3:
    bucket: risk-analysis
    html-prefix: reports/html/
    xbrl-prefix: reports/xbrl/
    # File naming pattern: Comprehensive_Risk_Analysis_{BankID}_{YYYY-MM-DD}.{extension}
    encryption: AES256
    presigned-url-expiration-hours: 1
  
  # File path patterns for data retrieval (Requirements 3.1, 3.2)
  # Production: S3 URIs from events
  # Development: Local filesystem paths
  file-paths:
    calculation-pattern: "calculated/calc_batch_{batchId}.json"
    quality-pattern: "quality/quality_batch_{batchId}.json"
    local-base-path: "/data"
    malformed-json-path: "/tmp/malformed-json/"
  
  # Local fallback configuration (Requirement 12.5, 20.1)
  fallback:
    local-path: /tmp/deferred-reports/
    retry-interval-minutes: 30
    max-retry-attempts: 5
  
  # Async processing configuration (Requirements 1.3, 2.1, 2.2)
  async:
    core-pool-size: 2
    max-pool-size: 5
    queue-capacity: 100
    thread-name-prefix: report-gen-
    await-termination-seconds: 60
  
  # Event coordination configuration (Requirements 1.4, 1.5, 1.6)
  coordination:
    event-expiration-hours: 24
    cleanup-interval-minutes: 30
  
  # Performance targets (in milliseconds) (Requirement 16.1-16.5)
  performance:
    data-fetch-target: 800
    html-generation-target: 2000
    xbrl-generation-target: 800
    s3-upload-target: 800
    total-generation-target: 7000
    file-download-timeout: 30000 # 30 seconds
  
  # Retry configuration (Requirement 20.3)
  retry:
    max-retries: 3
    backoff-intervals-seconds: [1, 2, 4, 8, 16]
    retryable-exceptions:
      - "software.amazon.awssdk.services.s3.model.S3Exception"
      - "java.io.IOException"
      - "java.net.SocketTimeoutException"
    non-retryable-exceptions:
      - "software.amazon.awssdk.services.s3.model.NoSuchBucketException"
      - "software.amazon.awssdk.core.exception.SdkClientException"

# AWS Configuration
aws:
  region: eu-west-1
  s3:
    endpoint: ${AWS_S3_ENDPOINT:} # For LocalStack in development
  access-key-id: ${AWS_ACCESS_KEY_ID:}
  secret-access-key: ${AWS_SECRET_ACCESS_KEY:}

# Resilience4j Circuit Breaker Configuration (Requirement 22.1)
# Circuit breaker opens when:
# - 10 consecutive failures OR
# - Failure rate exceeds 50% over 5-minute window
# After 5 minutes in OPEN state, transitions to HALF_OPEN for 1 test call
resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 1
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 5m
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - software.amazon.awssdk.services.s3.model.S3Exception
          - java.io.IOException
          - java.net.SocketTimeoutException
        ignoreExceptions:
          - java.lang.IllegalArgumentException
          - java.lang.IllegalStateException
    instances:
      s3-upload:
        baseConfig: default
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 10
        minimumNumberOfCalls: 10  # Requires 10 calls before evaluating
        failureRateThreshold: 50  # Opens at 50% failure rate
        slowCallRateThreshold: 50
        slowCallDurationThreshold: 10s
        waitDurationInOpenState: 5m  # Wait 5 minutes before HALF_OPEN
        permittedNumberOfCallsInHalfOpenState: 1  # Allow 1 test call
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - software.amazon.awssdk.services.s3.model.S3Exception
          - java.io.IOException
          - java.net.SocketTimeoutException
        ignoreExceptions:
          - software.amazon.awssdk.services.s3.model.NoSuchBucketException
          - software.amazon.awssdk.core.exception.SdkClientException

  # Retry configuration for transient failures (Requirement 20.3)
  retry:
    configs:
      default:
        maxAttempts: 3
        waitDuration: 1s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - software.amazon.awssdk.services.s3.model.S3Exception
          - java.io.IOException
          - java.net.SocketTimeoutException
        ignoreExceptions:
          - software.amazon.awssdk.services.s3.model.NoSuchBucketException
          - java.lang.IllegalArgumentException
    instances:
      s3-operations:
        baseConfig: default
        maxAttempts: 3
        waitDuration: 1s

# Thymeleaf Configuration
spring:
  thymeleaf:
    prefix: classpath:/templates/reports/
    suffix: .html
    mode: HTML
    encoding: UTF-8
    cache: true # Enable caching in production
    check-template-location: true

---
# Development profile overrides
spring:
  config:
    activate:
      on-profile: development
  
  # Disable Thymeleaf caching in development for faster iteration
  thymeleaf:
    cache: false

report-generation:
  # Use development S3 bucket (Requirement 3.3, 3.4)
  s3:
    bucket: risk-analysis-dev
    enabled: false

  fallback:
    local-path: ./data/deferred-reports/
  
  # Use local filesystem for data retrieval in development
  file-paths:
    local-base-path: "/data"
  
  # Smaller thread pool for development
  async:
    core-pool-size: 2
    max-pool-size: 3
    queue-capacity: 50

# Use LocalStack for S3 in development (Requirement 3.3, 3.4)
aws:
  s3:
    endpoint: http://localhost:4566

# More lenient circuit breaker in development
resilience4j:
  circuitbreaker:
    instances:
      s3-upload:
        failureRateThreshold: 80
        waitDurationInOpenState: 1m
        minimumNumberOfCalls: 5

---
# Production profile overrides
spring:
  config:
    activate:
      on-profile: production
  
  # Enable Thymeleaf caching in production for performance
  thymeleaf:
    cache: true

report-generation:
  # Use production S3 bucket (Requirement 3.1, 3.2, 12.1)
  s3:
    bucket: risk-analysis-production
  
  # Larger thread pool for production load
  async:
    core-pool-size: 5
    max-pool-size: 10
    queue-capacity: 200
  
  # Stricter performance targets in production
  performance:
    data-fetch-target: 800
    html-generation-target: 2000
    xbrl-generation-target: 800
    s3-upload-target: 800
    total-generation-target: 7000

# Stricter circuit breaker in production (Requirement 22.1)
resilience4j:
  circuitbreaker:
    instances:
      s3-upload:
        failureRateThreshold: 50
        waitDurationInOpenState: 5m
        minimumNumberOfCalls: 10
