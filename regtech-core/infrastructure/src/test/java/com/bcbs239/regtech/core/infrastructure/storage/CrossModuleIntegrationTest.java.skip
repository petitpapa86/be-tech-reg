package com.bcbs239.regtech.core.infrastructure.storage;

import com.bcbs239.regtech.core.domain.storage.IStorageService;
import com.bcbs239.regtech.core.domain.storage.Result;
import com.bcbs239.regtech.core.domain.storage.StorageResult;
import com.bcbs239.regtech.core.domain.storage.StorageUri;
import com.bcbs239.regtech.core.infrastructure.aws.CoreS3Service;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.*;
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.CreateBucketRequest;
import software.amazon.awssdk.services.s3.presigner.S3Presigner;

import java.net.URI;
import java.time.Duration;
import java.util.HashMap;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * Cross-Module Integration Tests
 * 
 * Purpose: Verify that shared IStorageService works end-to-end across multiple modules
 * 
 * Test Scenarios:
 * 1. Data-quality writes validation results → Report-generation reads them
 * 2. Risk-calculation writes calculation results → Report-generation reads them
 * 3. Full pipeline: All modules share storage seamlessly
 * 
 * Environment: LocalStack S3 (must be running on localhost:4566)
 */
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
class CrossModuleIntegrationTest {

    private static S3Client s3Client;
    private static S3Presigner s3Presigner;
    private static IStorageService storageService;
    private static final String TEST_BUCKET = "regtech-cross-module-test";
    private static final String LOCALSTACK_ENDPOINT = "http://localhost:4566";

    @BeforeAll
    static void setUp() {
        // Create S3 client pointing to LocalStack
        s3Client = S3Client.builder()
                .endpointOverride(URI.create(LOCALSTACK_ENDPOINT))
                .region(Region.US_EAST_1)
                .credentialsProvider(
                        StaticCredentialsProvider.create(
                                AwsBasicCredentials.create("test", "test")
                        )
                )
                .forcePathStyle(true)
                .build();

        // Create S3 presigner
        s3Presigner = S3Presigner.builder()
                .endpointOverride(URI.create(LOCALSTACK_ENDPOINT))
                .region(Region.US_EAST_1)
                .credentialsProvider(
                        StaticCredentialsProvider.create(
                                AwsBasicCredentials.create("test", "test")
                        )
                )
                .build();

        // Create test bucket
        try {
            s3Client.createBucket(CreateBucketRequest.builder()
                    .bucket(TEST_BUCKET)
                    .build());
        } catch (Exception e) {
            // Bucket might already exist
        }

        // Create CoreS3Service
        CoreS3Service coreS3Service = new CoreS3Service(null, s3Client, s3Presigner);

        // Create JsonStorageHelper
        ObjectMapper objectMapper = new ObjectMapper();
        JsonStorageHelper jsonHelper = new JsonStorageHelper(objectMapper);

        // Create StorageServiceAdapter
        storageService = new StorageServiceAdapter(coreS3Service, jsonHelper);
    }

    @AfterAll
    static void tearDown() {
        if (s3Presigner != null) {
            s3Presigner.close();
        }
        if (s3Client != null) {
            s3Client.close();
        }
    }

    /**
     * Test 1: Data-Quality → Report-Generation Workflow
     * 
     * Simulates:
     * - Data-quality module writes validation results to S3
     * - Report-generation module reads those results
     * 
     * Validates:
     * - Cross-module data sharing works
     * - JSON serialization/deserialization is consistent
     * - Metadata is preserved across modules
     */
    @Test
    @Order(1)
    @DisplayName("Test 1: Data-quality writes validation results, report-generation reads them")
    void testDataQualityToReportGenerationWorkflow() {
        // ARRANGE: Simulate data-quality module writing validation results
        String validationResults = """
            {
                "batchId": "batch-001",
                "totalRecords": 1000,
                "validRecords": 950,
                "invalidRecords": 50,
                "qualityScore": 95.0,
                "dimensions": {
                    "completeness": 98.0,
                    "accuracy": 92.0,
                    "timeliness": 95.0,
                    "consistency": 94.0,
                    "integrity": 96.0,
                    "validity": 93.0
                },
                "violations": [
                    {
                        "ruleId": "RULE-001",
                        "severity": "HIGH",
                        "count": 30,
                        "description": "Missing ISIN codes"
                    },
                    {
                        "ruleId": "RULE-002",
                        "severity": "MEDIUM",
                        "count": 20,
                        "description": "Invalid currency codes"
                    }
                ]
            }
            """;

        StorageUri uri = StorageUri.parse("s3://" + TEST_BUCKET + "/data-quality/validation-results/batch-001.json");
        Map<String, String> metadata = new HashMap<>();
        metadata.put("module", "data-quality");
        metadata.put("batchId", "batch-001");
        metadata.put("timestamp", "2026-01-08T14:30:00Z");

        // ACT: Data-quality writes to S3
        Result<StorageResult> uploadResult = storageService.upload(validationResults, uri, metadata);

        // ASSERT: Upload successful
        assertThat(uploadResult.isSuccess()).isTrue();
        assertThat(uploadResult.getValueOrThrow().uri()).isEqualTo(uri.uri());

        // ACT: Report-generation reads from S3
        Result<String> downloadResult = storageService.download(uri);

        // ASSERT: Download successful and content matches
        assertThat(downloadResult.isSuccess()).isTrue();
        String downloadedContent = downloadResult.getValueOrThrow();
        assertThat(downloadedContent).contains("batch-001");
        assertThat(downloadedContent).contains("qualityScore");
        assertThat(downloadedContent).contains("95.0");
        assertThat(downloadedContent).contains("violations");
        
        System.out.println("✅ Test 1 PASSED: Data-quality → Report-generation workflow");
    }

    /**
     * Test 2: Risk-Calculation → Report-Generation Workflow
     * 
     * Simulates:
     * - Risk-calculation module writes calculation results to S3
     * - Report-generation module reads those results
     * 
     * Validates:
     * - Cross-module data sharing for risk data
     * - Large payload handling
     * - Metadata tagging for risk calculations
     */
    @Test
    @Order(2)
    @DisplayName("Test 2: Risk-calculation writes results, report-generation reads them")
    void testRiskCalculationToReportGenerationWorkflow() {
        // ARRANGE: Simulate risk-calculation module writing results
        String riskResults = """
            {
                "batchId": "risk-batch-001",
                "calculationDate": "2026-01-08",
                "portfolioId": "PORTFOLIO-A",
                "riskMetrics": {
                    "creditRisk": {
                        "totalExposure": 1500000000.00,
                        "expectedLoss": 15000000.00,
                        "var95": 50000000.00,
                        "cvar95": 75000000.00
                    },
                    "marketRisk": {
                        "equityRisk": 25000000.00,
                        "fxRisk": 10000000.00,
                        "interestRateRisk": 30000000.00
                    },
                    "operationalRisk": {
                        "expectedLoss": 5000000.00,
                        "unexpectedLoss": 8000000.00
                    }
                },
                "counterparties": [
                    {
                        "counterpartyId": "CP-001",
                        "lei": "LEI1234567890ABCDEF",
                        "exposure": 500000000.00,
                        "creditRating": "AA-"
                    },
                    {
                        "counterpartyId": "CP-002",
                        "lei": "LEI0987654321FEDCBA",
                        "exposure": 300000000.00,
                        "creditRating": "A+"
                    }
                ],
                "summary": {
                    "totalRisk": 120000000.00,
                    "riskCategory": "MEDIUM",
                    "complianceStatus": "COMPLIANT"
                }
            }
            """;

        StorageUri uri = StorageUri.parse("s3://" + TEST_BUCKET + "/risk-calculation/results/risk-batch-001.json");
        Map<String, String> metadata = new HashMap<>();
        metadata.put("module", "risk-calculation");
        metadata.put("batchId", "risk-batch-001");
        metadata.put("portfolioId", "PORTFOLIO-A");
        metadata.put("calculationDate", "2026-01-08");

        // ACT: Risk-calculation writes to S3
        Result<StorageResult> uploadResult = storageService.upload(riskResults, uri, metadata);

        // ASSERT: Upload successful
        assertThat(uploadResult.isSuccess()).isTrue();

        // ACT: Report-generation reads from S3
        Result<String> downloadResult = storageService.download(uri);

        // ASSERT: Download successful and content matches
        assertThat(downloadResult.isSuccess()).isTrue();
        String downloadedContent = downloadResult.getValueOrThrow();
        assertThat(downloadedContent).contains("risk-batch-001");
        assertThat(downloadedContent).contains("creditRisk");
        assertThat(downloadedContent).contains("totalExposure");
        assertThat(downloadedContent).contains("1500000000.00");
        assertThat(downloadedContent).contains("counterparties");
        assertThat(downloadedContent).contains("LEI1234567890ABCDEF");
        
        System.out.println("✅ Test 2 PASSED: Risk-calculation → Report-generation workflow");
    }

    /**
     * Test 3: Full Pipeline - All Modules Share Storage
     * 
     * Simulates:
     * - Data-quality writes initial data
     * - Risk-calculation reads DQ data, writes risk results
     * - Report-generation reads both DQ and risk data
     * 
     * Validates:
     * - Multi-module pipeline works end-to-end
     * - Data flows correctly between all 3 modules
     * - Storage service handles concurrent access
     */
    @Test
    @Order(3)
    @DisplayName("Test 3: Full pipeline - data-quality → risk-calculation → report-generation")
    void testFullPipelineAllModules() {
        String batchId = "full-pipeline-001";

        // STEP 1: Data-quality writes initial validation data
        String dqData = """
            {
                "batchId": "%s",
                "qualityScore": 96.5,
                "recordCount": 5000,
                "status": "VALIDATED"
            }
            """.formatted(batchId);

        StorageUri dqUri = StorageUri.parse("s3://" + TEST_BUCKET + "/pipeline/dq/" + batchId + ".json");
        Result<StorageResult> dqUpload = storageService.upload(dqData, dqUri, Map.of("source", "data-quality"));
        assertThat(dqUpload.isSuccess()).isTrue();
        System.out.println("  ✓ Step 1: Data-quality wrote validation data");

        // STEP 2: Risk-calculation reads DQ data
        Result<String> dqRead = storageService.download(dqUri);
        assertThat(dqRead.isSuccess()).isTrue();
        assertThat(dqRead.getValueOrThrow()).contains(batchId);
        System.out.println("  ✓ Step 2: Risk-calculation read DQ data");

        // STEP 3: Risk-calculation writes risk results
        String riskData = """
            {
                "batchId": "%s",
                "totalRisk": 85000000.00,
                "riskCategory": "LOW",
                "linkedDQBatch": "%s"
            }
            """.formatted(batchId, batchId);

        StorageUri riskUri = StorageUri.parse("s3://" + TEST_BUCKET + "/pipeline/risk/" + batchId + ".json");
        Result<StorageResult> riskUpload = storageService.upload(riskData, riskUri, Map.of("source", "risk-calculation"));
        assertThat(riskUpload.isSuccess()).isTrue();
        System.out.println("  ✓ Step 3: Risk-calculation wrote risk results");

        // STEP 4: Report-generation reads both DQ and risk data
        Result<String> dqDataForReport = storageService.download(dqUri);
        Result<String> riskDataForReport = storageService.download(riskUri);

        assertThat(dqDataForReport.isSuccess()).isTrue();
        assertThat(riskDataForReport.isSuccess()).isTrue();

        String dqContent = dqDataForReport.getValueOrThrow();
        String riskContent = riskDataForReport.getValueOrThrow();

        assertThat(dqContent).contains(batchId).contains("qualityScore").contains("96.5");
        assertThat(riskContent).contains(batchId).contains("totalRisk").contains("85000000.00");
        System.out.println("  ✓ Step 4: Report-generation read both DQ and risk data");

        // STEP 5: Report-generation writes final report
        String reportData = """
            {
                "reportId": "REPORT-%s",
                "batchId": "%s",
                "qualityScore": 96.5,
                "totalRisk": 85000000.00,
                "reportStatus": "COMPLETED",
                "generatedAt": "2026-01-08T15:00:00Z"
            }
            """.formatted(batchId, batchId);

        StorageUri reportUri = StorageUri.parse("s3://" + TEST_BUCKET + "/pipeline/reports/" + batchId + ".json");
        Result<StorageResult> reportUpload = storageService.upload(reportData, reportUri, Map.of("source", "report-generation"));
        assertThat(reportUpload.isSuccess()).isTrue();
        System.out.println("  ✓ Step 5: Report-generation wrote final report");

        // FINAL VERIFICATION: Verify all 3 files exist and are accessible
        Result<String> finalDqCheck = storageService.download(dqUri);
        Result<String> finalRiskCheck = storageService.download(riskUri);
        Result<String> finalReportCheck = storageService.download(reportUri);

        assertThat(finalDqCheck.isSuccess()).isTrue();
        assertThat(finalRiskCheck.isSuccess()).isTrue();
        assertThat(finalReportCheck.isSuccess()).isTrue();

        System.out.println("✅ Test 3 PASSED: Full pipeline across all 3 modules");
        System.out.println("   - Data-quality ✓");
        System.out.println("   - Risk-calculation ✓");
        System.out.println("   - Report-generation ✓");
    }
}
