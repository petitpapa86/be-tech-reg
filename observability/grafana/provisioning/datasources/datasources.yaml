# ============================================================================
# Grafana Data Sources Configuration (Hetzner Deployment)
# ============================================================================
# Auto-provisioned data sources for Tempo, Loki, and Prometheus
# Requirements: 6.1, 6.2
# ============================================================================

apiVersion: 1

datasources:
  # Prometheus - Metrics
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
    jsonData:
      timeInterval: 15s
      queryTimeout: 60s
      httpMethod: POST
    version: 1

  # Tempo - Traces
  - name: Tempo
    type: tempo
    access: proxy
    url: http://tempo:3200
    editable: true
    jsonData:
      httpMethod: GET
      tracesToLogs:
        datasourceUid: loki
        tags: ['job', 'instance', 'pod', 'namespace']
        mappedTags: [{ key: 'service.name', value: 'service' }]
        mapTagNamesEnabled: false
        spanStartTimeShift: '1h'
        spanEndTimeShift: '1h'
        filterByTraceID: false
        filterBySpanID: false
      tracesToMetrics:
        datasourceUid: prometheus
        tags: [{ key: 'service.name', value: 'service' }, { key: 'job' }]
        queries:
          - name: 'Sample query'
            query: 'sum(rate(tempo_spanmetrics_latency_bucket{$__tags}[5m]))'
      serviceMap:
        datasourceUid: prometheus
      search:
        hide: false
      nodeGraph:
        enabled: true
      lokiSearch:
        datasourceUid: loki
    version: 1

  # Loki - Logs
  - name: Loki
    type: loki
    access: proxy
    url: http://loki:3100
    editable: true
    jsonData:
      maxLines: 1000
      derivedFields:
        - datasourceUid: tempo
          matcherRegex: "traceID=(\\w+)"
          name: TraceID
          url: '$${__value.raw}'
    version: 1

# ============================================================================
# CONFIGURATION NOTES
# ============================================================================
# 1. Data source connections:
#    - Prometheus: http://prometheus:9090 (metrics)
#    - Tempo: http://tempo:3200 (traces)
#    - Loki: http://loki:3100 (logs)
#
# 2. Prometheus configuration:
#    - Default data source for dashboards
#    - 15-second time interval matches scrape interval
#    - 60-second query timeout for complex queries
#
# 3. Tempo configuration:
#    - Traces to logs: Links traces to Loki logs
#    - Traces to metrics: Links traces to Prometheus metrics
#    - Service map: Visualizes service dependencies
#    - Node graph: Shows trace flow between services
#
# 4. Loki configuration:
#    - Max 1000 lines per query (adjust for performance)
#    - Derived fields: Extracts trace IDs from logs
#    - Links logs to Tempo traces
#
# 5. Integration features:
#    - Click trace ID in logs → Jump to trace in Tempo
#    - Click service in trace → View metrics in Prometheus
#    - Click span in trace → View related logs in Loki
#
# 6. Customization:
#    - Adjust timeInterval for different scrape intervals
#    - Modify maxLines based on log volume
#    - Add custom derived fields for additional linking
# ============================================================================
