# ============================================================================
# OpenTelemetry Collector Configuration (Hetzner Deployment)
# ============================================================================
# Receives telemetry data from applications and exports to backends
# Requirements: 1.1, 2.1, 3.1
# ============================================================================

receivers:
  # OTLP receiver for traces, metrics, and logs
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://*"
            - "https://*"

  # Prometheus receiver for scraping metrics
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 10s
          static_configs:
            - targets: ['localhost:8888']

processors:
  # Batch processor for efficient export
  batch:
    timeout: 10s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # Memory limiter to prevent OOM
  memory_limiter:
    check_interval: 1s
    limit_mib: 512
    spike_limit_mib: 128

  # Resource processor to add deployment attributes
  resource:
    attributes:
      - key: deployment.provider
        value: hetzner
        action: upsert
      - key: collector.version
        value: 0.91.0
        action: upsert

  # Attributes processor for trace enrichment
  attributes:
    actions:
      - key: environment
        from_attribute: deployment.environment
        action: upsert

exporters:
  # Tempo exporter for traces
  otlp/tempo:
    endpoint: tempo:4317
    tls:
      insecure: true

  # Prometheus exporter for metrics
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: bcbs239
    const_labels:
      deployment: hetzner

  # Logging exporter for debugging (optional)
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

service:
  pipelines:
    # Traces pipeline
    traces:
      receivers: [otlp]
      processors: [memory_limiter, batch, resource, attributes]
      exporters: [otlp/tempo, logging]

    # Metrics pipeline
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, batch, resource]
      exporters: [prometheus, logging]

  # Telemetry configuration
  telemetry:
    logs:
      level: info
    metrics:
      level: detailed
      address: 0.0.0.0:8888

  # Extensions for health checks and monitoring
  extensions: [health_check, pprof, zpages]

extensions:
  # Health check extension
  health_check:
    endpoint: 0.0.0.0:13133

  # Performance profiling
  pprof:
    endpoint: 0.0.0.0:1777

  # zPages for debugging
  zpages:
    endpoint: 0.0.0.0:55679

# ============================================================================
# CONFIGURATION NOTES
# ============================================================================
# 1. Receivers:
#    - OTLP gRPC: Port 4317 (recommended for production)
#    - OTLP HTTP: Port 4318 (easier for debugging)
#    - Prometheus: Scrapes collector's own metrics
#
# 2. Processors:
#    - batch: Improves export efficiency
#    - memory_limiter: Prevents OOM crashes
#    - resource: Adds Hetzner-specific attributes
#    - attributes: Enriches trace data
#
# 3. Exporters:
#    - otlp/tempo: Sends traces to Tempo
#    - prometheus: Exposes metrics for Prometheus scraping
#    - loki: Sends logs to Loki
#    - logging: Debug output (disable in production)
#
# 4. Performance tuning:
#    - Adjust batch_size for throughput vs latency
#    - Increase memory_limiter for high-volume environments
#    - Disable logging exporter in production
#
# 5. Security:
#    - Enable TLS for production deployments
#    - Configure authentication for OTLP receivers
#    - Restrict CORS origins to known domains
# ============================================================================
