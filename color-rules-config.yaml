# ============================================
# BCBS 239 Report - Color Consistency Rules
# ============================================
#
# Source of truth for all *conditional* color rules used by the Thymeleaf
# template:
#   regtech-report-generation/infrastructure/src/main/resources/templates/reports/comprehensive-report.html
#
# Notes
# - Keep thresholds consistent across all elements in the same rule family.
# - This config covers BOTH Thymeleaf-driven conditional classes and the
#   small “rules-as-code” palettes embedded in the template's JS.
#
version: "1.0"
last_updated: "2025-12-23"

sources:
  thymeleaf_template:
    path: "regtech-report-generation/infrastructure/src/main/resources/templates/reports/comprehensive-report.html"
  server_side_generator:
    path: "regtech-report-generation/infrastructure/src/main/java/com/bcbs239/regtech/reportgeneration/infrastructure/templates/HtmlReportGeneratorImpl.java"

# --------------------------------------------
# RULE FAMILY 1: Dimension Score Colors
# --------------------------------------------
dimension_scores:
  description: "Color rules for quality dimension scores (Completeness, Accuracy, Consistency, Timeliness, Uniqueness, Validity)"

  applies_to:
    section: "Punteggi per Dimensione di Qualità"
    elements:
      - type: "score_percentage_text"
        selector_hint: "span.text-3xl.font-bold"
      - type: "error_count_text"
        selector_hint: "p.text-xs.font-semibold"
      - type: "progress_bar_fill"
        selector_hint: "div.h-4.rounded-full (inner bar)"

  thresholds:
    excellent:
      condition: ">= 90"
      percentage: 90.0
      colors:
        text: "text-green-600"
        bar_fill: "bg-green-600"
      label: "EXCELLENT"

    acceptable:
      condition: ">= 75 AND < 90"
      min_percentage: 75.0
      max_percentage: 89.99
      colors:
        text: "text-amber-600"
        bar_fill: "bg-amber-500"  # intentionally lighter shade for visual hierarchy
      label: "ACCEPTABLE"

    poor:
      condition: "< 75"
      max_percentage: 74.99
      colors:
        text: "text-red-600"
        bar_fill: "bg-red-600"
      label: "POOR"

  dimensions:
    completeness:
      variable: "cpl"
      error_variable: "cplErr"
      label_it: "Completezza"
      label_en: "Completeness"
      description_it: "Tutti i dati richiesti sono presenti e popolati"
      error_label_it: "ERRORI"
      template_locations:
        score_text_line: 454
        error_text_line: 459
        bar_fill_line: 467

    accuracy:
      variable: "acc"
      error_variable: "accErr"
      label_it: "Accuratezza"
      label_en: "Accuracy"
      description_it: "I dati riflettono correttamente la realtà"
      error_label_it: "ERRORI"
      template_locations:
        score_text_line: 482
        error_text_line: 487
        bar_fill_line: 495

    consistency:
      variable: "con"
      error_variable: "conErr"
      label_it: "Coerenza"
      label_en: "Consistency"
      description_it: "I dati sono uniformi tra diverse fonti e nel tempo"
      error_label_it: "ERRORE"
      template_locations:
        score_text_line: 510
        error_text_line: 515
        bar_fill_line: 523

    timeliness:
      variable: "tim"
      error_variable: "timErr"
      label_it: "Tempestività"
      label_en: "Timeliness"
      description_it: "I dati sono aggiornati e disponibili quando necessari"
      error_label_it: "ERRORI"
      template_locations:
        score_text_line: 538
        error_text_line: 543
        bar_fill_line: 551

    uniqueness:
      variable: "uni"
      error_variable: "uniErr"
      label_it: "Unicità"
      label_en: "Uniqueness"
      description_it: "Non ci sono duplicazioni nei dati"
      error_label_it: "ERRORI"
      template_locations:
        score_text_line: 566
        error_text_line: 571
        bar_fill_line: 579

    validity:
      variable: "val"
      error_variable: "valErr"
      label_it: "Validità"
      label_en: "Validity"
      description_it: "I dati rispettano le regole di business e i formati attesi"
      error_label_it: "ERRORI"
      template_locations:
        score_text_line: 594
        error_text_line: 599
        bar_fill_line: 607

# --------------------------------------------
# RULE FAMILY 2: Error Distribution Colors
# --------------------------------------------
error_distribution:
  description: "Color rules for error distribution cards based on per-dimension error count severity"

  applies_to:
    section: "Distribuzione Errori per Dimensione"
    elements:
      - type: "card_background_and_border"
        selector_hint: "div.rounded-lg.p-6.border-2"
      - type: "dimension_title"
        selector_hint: "p.text-sm.font-semibold"
      - type: "severity_label"
        selector_hint: "p.text-xs.mt-1"
      - type: "error_count_number"
        selector_hint: "span.text-3xl.font-bold"
      - type: "progress_bar_background"
        selector_hint: "div.w-full.rounded-full.h-3 (outer bar)"
      - type: "progress_bar_fill"
        selector_hint: "div.h-3.rounded-full (inner bar)"
      - type: "percentage_text"
        selector_hint: "p.text-xs.mt-2"

  thresholds:
    critical:
      condition: "> 100"
      min_count: 101
      colors:
        background: "bg-red-50"
        border: "border-red-200"
        text_primary: "text-red-800"
        text_secondary: "text-red-600"
        bar_background: "bg-red-200"
        bar_fill: "bg-red-600"
        text_tertiary: "text-red-700"
      label_it: "Situazione critica!"
      label_en: "Critical situation!"

    high:
      condition: "> 50 AND <= 100"
      min_count: 51
      max_count: 100
      colors:
        background: "bg-orange-50"
        border: "border-orange-200"
        text_primary: "text-orange-800"
        text_secondary: "text-orange-600"
        bar_background: "bg-orange-200"
        bar_fill: "bg-orange-600"
        text_tertiary: "text-orange-700"
      label_it: "Richiede attenzione"
      label_en: "Requires attention"

    medium:
      condition: "> 10 AND <= 50"
      min_count: 11
      max_count: 50
      colors:
        background: "bg-yellow-50"
        border: "border-yellow-200"
        text_primary: "text-yellow-800"
        text_secondary: "text-yellow-600"
        bar_background: "bg-yellow-200"
        bar_fill: "bg-yellow-600"
        text_tertiary: "text-yellow-700"
      label_it: "Errori moderati"
      label_en: "Moderate errors"

    low:
      condition: "<= 10"
      max_count: 10
      colors:
        background: "bg-green-50"
        border: "border-green-200"
        text_primary: "text-green-800"
        text_secondary: "text-green-600"
        bar_background: "bg-green-200"
        bar_fill: "bg-green-600"
        text_tertiary: "text-green-700"
      label_it: "Errori minimi"
      label_en: "Minimal errors"

  dimensions:
    completeness:
      variable: "cplCnt"
      label: "COMPLETENESS"
      subtitle_fallback_it: "Dimensione più problematica"
      template_locations:
        severity_with_line: 627
        first_classappend_line: 628

    accuracy:
      variable: "accCnt"
      label: "ACCURACY"
      subtitle_fallback_it: "Seconda dimensione critica"
      template_locations:
        severity_with_line: 676
        first_classappend_line: 677

    consistency:
      variable: "conCnt"
      label: "CONSISTENCY"
      subtitle_fallback_it: "Terza dimensione critica"
      template_locations:
        severity_with_line: 725
        first_classappend_line: 726

# --------------------------------------------
# RULE FAMILY 3: Overall Quality Grade Colors
# --------------------------------------------
overall_grade:
  description: "Gradient color rules for overall grade card (mapped from grade letter)"
  applies_to:
    section: "Punteggio Complessivo"
    element:
      type: "grade_card_gradient"
      selector_hint: "div.bg-gradient-to-br"

  mapping:
    A:
      colors:
        gradient_from: "from-green-500"
        gradient_to: "to-green-600"
      label: "EXCELLENT - Industry Leading"
    B:
      colors:
        gradient_from: "from-amber-500"
        gradient_to: "to-amber-600"
      label: "GOOD - Minor Improvements Needed"
    C:
      colors:
        gradient_from: "from-yellow-500"
        gradient_to: "to-yellow-600"
      label: "ACCEPTABLE - Some Improvements Needed"
    D:
      colors:
        gradient_from: "from-orange-500"
        gradient_to: "to-orange-600"
      label: "WEAK - Requires Action"
    E_F:
      colors:
        gradient_from: "from-red-500"
        gradient_to: "to-red-600"
      label: "POOR - Requires Immediate Action"

  template_locations:
    grade_gradient_line: 395

# --------------------------------------------
# RULE FAMILY 4: BCBS 239 Compliance Badges
# --------------------------------------------
bcbs239_compliance:
  description: "Color rules for BCBS 239 principle compliance badges"

  applies_to:
    section: "Conformità BCBS 239"
    element:
      type: "compliance_badge"
      selector_hint: "span.px-3.py-1.text-xs.font-bold.rounded-full"

  principles:
    principle_3:
      name: "Principle 3 - Accuracy and Integrity"
      dimension: "ACCURACY"
      threshold: 90.0
      source: "HtmlReportGeneratorImpl#prepareBCBS239Compliance"

    principle_4:
      name: "Principle 4 - Completeness"
      dimension: "COMPLETENESS"
      threshold: 90.0
      source: "HtmlReportGeneratorImpl#prepareBCBS239Compliance"

    principle_5:
      name: "Principle 5 - Timeliness"
      dimension: "TIMELINESS"
      threshold: 90.0
      source: "HtmlReportGeneratorImpl#prepareBCBS239Compliance"

    principle_6:
      name: "Principle 6 - Adaptability"
      dimension: "CONSISTENCY"
      threshold: 70.0
      source: "HtmlReportGeneratorImpl#prepareBCBS239Compliance"

  badges:
    compliant:
      condition: "assessment.compliant == true"
      colors:
        background: "bg-green-100"
        text: "text-green-800"
      label_it: "CONFORME"
      label_en: "COMPLIANT"

    non_compliant:
      condition: "assessment.compliant == false"
      colors:
        background: "bg-red-100"
        text: "text-red-800"
      label_it: "NON CONFORME"
      label_en: "NON-COMPLIANT"

  template_locations:
    badge_classappend_line: 826

# --------------------------------------------
# Additional Conditional Color Rules (Risk + Status)
# --------------------------------------------
additional_rules:
  risk_sector_theme_badge:
    description: "Sector badge color varies by computed row.theme"
    input_variable: "row.theme"
    template_locations:
      line: 199
    mapping:
      bank: "bg-green-100 text-green-800"
      insurance: "bg-purple-100 text-purple-800"
      other: "bg-gray-100 text-gray-800"
      default: "bg-blue-100 text-blue-800"

  top10_exposure_card_theme:
    description: "Top-10 exposure cards use gradients/borders by card.theme"
    input_variable: "card.theme"
    template_locations:
      line: 229
    mapping:
      rank1: "bg-gradient-to-r from-red-50 to-red-100 border-l-4 border-red-500"
      rank2: "bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-500"
      rank3: "bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-500"
      bank: "bg-gradient-to-r from-green-50 to-green-100 border-l-4 border-green-500"
      insurance: "bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-500"
      other: "bg-gradient-to-r from-gray-50 to-gray-100 border-l-4 border-gray-400"
      default: "bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400"

  top3_limit_badge:
    description: "Top-3 exposure badge is red when limit exceeded, green otherwise"
    input_variable: "card.limitExceeded"
    template_locations:
      line: 239
    mapping:
      true: "bg-red-100 text-red-800 border-red-600"
      false: "bg-green-100 text-green-800 border-green-600"

  compliance_status_badge:
    description: "Validation status badge color based on complianceStatus"
    input_variable: "qualityResults.complianceStatus.name()"
    template_locations:
      line: 357
    mapping:
      COMPLIANT: "bg-green-100 text-green-800"
      default: "bg-red-100 text-red-800"

  attention_level_colors:
    description: "Attention level card + label + badge colors based on attentionLevel"
    input_variable: "qualityResults.attentionLevel.name()"
    template_locations:
      container_line: 364
      label_line: 367
      badge_line: 369
    mapping:
      LOW:
        container: "bg-green-50 border-green-200"
        label: "text-green-800"
        badge: "bg-green-600 text-white"
      MEDIUM:
        container: "bg-yellow-50 border-yellow-200"
        label: "text-yellow-800"
        badge: "bg-yellow-600 text-white"
      default:
        container: "bg-red-50 border-red-200"
        label: "text-red-800"
        badge: "bg-red-600 text-white"

  # Client-side palette used for the "Quality insights" section.
  # These are not Thymeleaf conditionals, but they govern conditional coloring in the template.
  quality_insights_palette_js:
    description: "JS palette for quality insights cards (severity -> Tailwind classes)"
    location_hint: "Inline script: qualityRules.insightColors"
    colors:
      critical: { bg: "bg-red-50", border: "border-red-500", title: "text-red-900", text: "text-red-800" }
      high: { bg: "bg-orange-50", border: "border-orange-500", title: "text-orange-900", text: "text-orange-800" }
      medium: { bg: "bg-amber-50", border: "border-amber-500", title: "text-amber-900", text: "text-amber-800" }
      success: { bg: "bg-green-50", border: "border-green-500", title: "text-green-900", text: "text-green-800" }
      info: { bg: "bg-blue-50", border: "border-blue-500", title: "text-blue-900", text: "text-blue-800" }

# --------------------------------------------
# Code Generation Templates (snippets)
# --------------------------------------------
templates:
  dimension_score_html: |
    <!-- @@DIMENSION_NAME@@ -->
    <div>
        <div class="flex justify-between items-center mb-2">
            <div>
                <h4 class="text-lg font-bold text-gray-900">@@LABEL_IT@@ (@@LABEL_EN@@)</h4>
                <p class="text-sm text-gray-600">@@DESCRIPTION_IT@@</p>
            </div>
            <div class="text-right">
                <span class="text-3xl font-bold"
                      th:classappend="${@@VAR@@ != null && @@VAR@@ >= @@THRESH_EXCELLENT@@ ? 'text-green-600' : 
                                      @@VAR@@ != null && @@VAR@@ >= @@THRESH_ACCEPTABLE@@ ? 'text-amber-600' : 
                                      'text-red-600'}"
                      th:text="${#numbers.formatDecimal((@@VAR@@ != null ? @@VAR@@ : 0), 1, 1)} + '%'"><span>0.0%</span></span>
                <p class="text-xs font-semibold"
                   th:classappend="${@@VAR@@ != null && @@VAR@@ >= @@THRESH_EXCELLENT@@ ? 'text-green-600' : 
                                   @@VAR@@ != null && @@VAR@@ >= @@THRESH_ACCEPTABLE@@ ? 'text-amber-600' : 
                                   'text-red-600'}"><span th:text="${@@ERROR_VAR@@}">0</span> @@ERROR_LABEL_IT@@</p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4">
            <div class="h-4 rounded-full" 
                 th:style="${'width: ' + (@@VAR@@ != null ? @@VAR@@ : 0) + '%'}"
                 th:classappend="${@@VAR@@ != null && @@VAR@@ >= @@THRESH_EXCELLENT@@ ? 'bg-green-600' : 
                                 @@VAR@@ != null && @@VAR@@ >= @@THRESH_ACCEPTABLE@@ ? 'bg-amber-500' : 
                                 'bg-red-600'}"></div>
        </div>
    </div>

  error_distribution_card_html: |
    <!-- @@DIMENSION_NAME@@ Error Card -->
    <div class="rounded-lg p-6 border-2"
       th:with="severity=${@@ERROR_VAR@@ > @@THRESH_CRITICAL@@ ? 'critical' : @@ERROR_VAR@@ > @@THRESH_HIGH@@ ? 'high' : @@ERROR_VAR@@ > @@THRESH_MEDIUM@@ ? 'medium' : 'low'}"
       th:classappend="${severity == 'critical' ? 'bg-red-50 border-red-200' : 
               severity == 'high' ? 'bg-orange-50 border-orange-200' : 
               severity == 'medium' ? 'bg-yellow-50 border-yellow-200' : 
               'bg-green-50 border-green-200'}">
      <div class="flex justify-between items-start mb-4">
        <div>
          <p class="text-sm font-semibold"
             th:classappend="${severity == 'critical' ? 'text-red-800' : 
                     severity == 'high' ? 'text-orange-800' : 
                     severity == 'medium' ? 'text-yellow-800' : 
                     'text-green-800'}">@@DIMENSION_LABEL@@</p>
          <p class="text-xs mt-1"
             th:classappend="${severity == 'critical' ? 'text-red-600' : 
                     severity == 'high' ? 'text-orange-600' : 
                     severity == 'medium' ? 'text-yellow-600' : 
                     'text-green-600'}"
             th:text="${severity == 'critical' ? '@@LABEL_CRITICAL_IT@@' : 
                 severity == 'high' ? '@@LABEL_HIGH_IT@@' : 
                 severity == 'medium' ? '@@LABEL_MEDIUM_IT@@' : 
                 '@@LABEL_LOW_IT@@'}">@@SUBTITLE_FALLBACK_IT@@</p>
        </div>
        <span class="text-3xl font-bold"
            th:classappend="${severity == 'critical' ? 'text-red-600' : 
                    severity == 'high' ? 'text-orange-600' : 
                    severity == 'medium' ? 'text-yellow-600' : 
                    'text-green-600'}"
            th:text="${@@ERROR_VAR@@}">0</span>
      </div>
      <div class="w-full rounded-full h-3"
         th:classappend="${severity == 'critical' ? 'bg-red-200' : 
                 severity == 'high' ? 'bg-orange-200' : 
                 severity == 'medium' ? 'bg-yellow-200' : 
                 'bg-green-200'}">
        <div class="h-3 rounded-full"
           th:classappend="${severity == 'critical' ? 'bg-red-600' : 
                   severity == 'high' ? 'bg-orange-600' : 
                   severity == 'medium' ? 'bg-yellow-600' : 
                   'bg-green-600'}"
           th:style="${'width: ' + (maxCnt > 0 ? ((@@ERROR_VAR@@ * 100.0) / maxCnt) : 0) + '%'}" style="width: 100%"></div>
      </div>
      <p class="text-xs mt-2"
         th:classappend="${severity == 'critical' ? 'text-red-700' : 
                 severity == 'high' ? 'text-orange-700' : 
                 severity == 'medium' ? 'text-yellow-700' : 
                 'text-green-700'}"><span th:text="${qualityResults.totalErrors > 0 ? #numbers.formatDecimal((@@ERROR_VAR@@ * 100.0) / qualityResults.totalErrors, 1, 1) : '0.0'}">62.5</span>% degli errori totali</p>
